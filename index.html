<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PathfinderAI — Find Your UK University Programme</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' rx='8' fill='%2300B4D8'/><text x='50%25' y='55%25' text-anchor='middle' dominant-baseline='middle' font-family='sans-serif' font-weight='800' font-size='18' fill='white'>P</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--navy:#0B1D2E;--navy-light:#132D46;--navy-mid:#1A3A5C;--teal:#00B4D8;--teal-dark:#0096B4;--amber:#F4A940;--bg:#F3F6FA;--card:#FFFFFF;--text:#1A2B3C;--text-light:#5A6B7C;--text-muted:#8A9BAC;--border:#E2E8F0;--green:#059669;--green-bg:#D1FAE5;--amber-bg:#FEF3C7;--red:#DC2626;--red-bg:#FEE2E2;--blue-bg:#E0F2FE;--purple-bg:#F3E8FF}
body{font-family:'Sora',sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
.app{width:100%;min-height:100vh;background:var(--bg)}
.onboarding{min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(150deg,var(--navy) 0%,var(--navy-light) 40%,var(--navy-mid) 100%);padding:20px;position:relative;overflow:hidden}
.onboarding::before{content:'';position:absolute;top:-40%;right:-20%;width:70%;height:140%;background:radial-gradient(ellipse,rgba(0,180,216,0.07) 0%,transparent 65%);pointer-events:none}
.ob-card{background:rgba(255,255,255,0.025);backdrop-filter:blur(24px);border:1px solid rgba(255,255,255,0.07);border-radius:28px;padding:44px 48px;max-width:580px;width:100%;position:relative;z-index:1}
@media(max-width:640px){.ob-card{padding:28px 24px;border-radius:20px}}
.logo-row{display:flex;align-items:center;gap:11px;margin-bottom:10px}
.logo-sq{width:38px;height:38px;background:linear-gradient(135deg,var(--teal),var(--amber));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;color:#fff;font-weight:800}
.logo-t{font-size:22px;font-weight:700;color:#fff;letter-spacing:-0.5px}
.logo-hi{color:var(--teal)}
.ob-badge{display:inline-block;background:rgba(0,180,216,0.12);color:var(--teal);font-size:11px;font-weight:600;padding:4px 10px;border-radius:6px;margin-bottom:20px;letter-spacing:0.5px}
.ob-sub{font-size:13.5px;color:rgba(255,255,255,0.45);line-height:1.65;margin-bottom:32px}
.fg{margin-bottom:18px}
.fl{display:block;font-size:11px;font-weight:600;color:rgba(255,255,255,0.6);text-transform:uppercase;letter-spacing:1.2px;margin-bottom:7px}
.fi,.fs{width:100%;padding:11px 15px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:11px;color:#fff;font-family:'Sora',sans-serif;font-size:13.5px;outline:none;transition:border 0.2s}
.fi:focus,.fs:focus{border-color:var(--teal)}
.fi::placeholder{color:rgba(255,255,255,0.25)}
.fs option{background:var(--navy);color:#fff}
.fr{display:grid;grid-template-columns:1fr 1fr;gap:14px}
@media(max-width:500px){.fr{grid-template-columns:1fr}}
.chips{display:flex;flex-wrap:wrap;gap:7px}
.chip{padding:7px 15px;border-radius:20px;font-size:12.5px;font-weight:500;border:1px solid rgba(255,255,255,0.13);color:rgba(255,255,255,0.6);cursor:pointer;transition:all 0.2s;background:transparent;font-family:'Sora',sans-serif}
.chip:hover{border-color:var(--teal);color:#fff}
.chip.on{background:rgba(0,180,216,0.13);border-color:var(--teal);color:var(--teal)}
.go-btn{width:100%;padding:14px;border-radius:12px;border:none;background:linear-gradient(135deg,var(--teal),var(--teal-dark));color:#fff;font-family:'Sora',sans-serif;font-size:14.5px;font-weight:600;cursor:pointer;transition:all 0.3s;margin-top:10px}
.go-btn:hover{transform:translateY(-1px);box-shadow:0 8px 28px rgba(0,180,216,0.28)}
.go-btn:disabled{opacity:0.35;cursor:not-allowed;transform:none;box-shadow:none}
.chat{display:flex;flex-direction:column;height:100vh}
.ch-head{display:flex;align-items:center;justify-content:space-between;padding:14px 22px;background:var(--navy);flex-shrink:0;flex-wrap:wrap;gap:8px}
.ch-left{display:flex;align-items:center;gap:10px}
.ch-logo{width:30px;height:30px;background:linear-gradient(135deg,var(--teal),var(--amber));border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px;color:#fff;font-weight:800}
.ch-title{font-size:15px;font-weight:600;color:#fff}
.ch-tags{display:flex;gap:8px;font-size:11px;color:rgba(255,255,255,0.45);flex-wrap:wrap}
.ch-tag{background:rgba(255,255,255,0.06);padding:3px 9px;border-radius:5px}
.ch-trust{background:rgba(5,150,105,0.15);color:#34D399;padding:3px 9px;border-radius:5px;font-weight:600;font-size:10px;letter-spacing:0.5px}
.ch-back{background:none;border:1px solid rgba(255,255,255,0.15);color:rgba(255,255,255,0.5);padding:4px 10px;border-radius:6px;font-family:'Sora',sans-serif;font-size:11px;cursor:pointer;transition:all 0.2s;margin-right:4px}
.ch-back:hover{border-color:var(--teal);color:var(--teal)}
.ch-msgs{flex:1;overflow-y:auto;padding:20px 22px;display:flex;flex-direction:column;gap:14px}
.msg{max-width:88%;animation:fadeUp 0.3s ease}
@media(max-width:640px){.msg{max-width:96%}}
@keyframes fadeUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.msg.a{align-self:flex-start}.msg.u{align-self:flex-end}
.msg-who{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.8px;margin-bottom:5px;color:var(--text-muted)}
.msg.u .msg-who{text-align:right}
.bubble{padding:13px 17px;border-radius:16px;font-size:13.5px;line-height:1.7}
.msg.a .bubble{background:var(--card);border:1px solid var(--border);border-bottom-left-radius:4px;box-shadow:0 1px 3px rgba(0,0,0,0.03)}
.msg.u .bubble{background:var(--navy);color:#fff;border-bottom-right-radius:4px}
.pcards{display:flex;flex-direction:column;gap:14px;margin-top:14px}
.pcard{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden;transition:all 0.25s}
.pcard:hover{border-color:var(--teal);box-shadow:0 6px 24px rgba(0,180,216,0.08)}
.pc-top{padding:16px 18px 12px}
.pc-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:3px}
.pc-uni{font-size:11px;font-weight:600;color:var(--teal);text-transform:uppercase;letter-spacing:0.6px}
.pc-rank{font-size:10.5px;color:var(--text-muted);background:var(--bg);padding:2px 8px;border-radius:4px}
.pc-name{font-size:15px;font-weight:600;color:var(--text);margin-bottom:8px;line-height:1.3}
.pc-tags{display:flex;flex-wrap:wrap;gap:5px}
.pc-tag{font-size:10.5px;padding:3px 8px;border-radius:6px;font-weight:500}
.t-fee{background:var(--amber-bg);color:#92400E}.t-city{background:var(--blue-bg);color:#0369A1}.t-dur{background:var(--purple-bg);color:#6B21A8}.t-fnd{background:var(--green-bg);color:#065F46}
.pc-elig{display:flex;align-items:center;gap:6px;padding:7px 12px;margin:8px 18px 0;border-radius:8px;font-size:11.5px;font-weight:600}
.elig-direct{background:var(--green-bg);color:var(--green)}.elig-cond{background:var(--amber-bg);color:#D97706}.elig-below{background:var(--red-bg);color:var(--red)}.elig-unk{background:var(--bg);color:var(--text-muted)}
.pc-tabs{display:flex;border-top:1px solid var(--border);border-bottom:1px solid var(--border)}
.pc-tab{flex:1;padding:8px;text-align:center;font-size:10.5px;font-weight:600;color:var(--text-muted);cursor:pointer;transition:all 0.2s;letter-spacing:0.3px;background:transparent;border:none;font-family:'Sora',sans-serif;border-bottom:2px solid transparent}
.pc-tab:hover{color:var(--text)}.pc-tab.on{color:var(--teal);border-bottom-color:var(--teal)}
.pc-panel{padding:14px 18px}
.pc-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:6px}
@media(max-width:500px){.pc-stats{grid-template-columns:repeat(2,1fr)}}
.ps{text-align:center}.ps-v{font-size:17px;font-weight:700;color:var(--navy)}.ps-l{font-size:9.5px;color:var(--text-muted);margin-top:1px}
.slm-box{background:linear-gradient(135deg,#F0FDFA,#ECFDF5);border:1px solid #A7F3D0;border-radius:10px;padding:12px 14px}
.slm-title{font-size:11px;font-weight:700;color:var(--green);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:8px;display:flex;align-items:center;gap:6px}
.slm-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:8px}
.slm-stat{text-align:center}.slm-v{font-size:15px;font-weight:700;color:#065F46}.slm-l{font-size:9px;color:#047857}
.slm-note{font-size:11.5px;color:#065F46;line-height:1.5;font-style:italic}
.tc-box{background:linear-gradient(135deg,#FFFBEB,#FEF9E7);border:1px solid #FDE68A;border-radius:10px;padding:12px 14px}
.tc-title{font-size:11px;font-weight:700;color:#92400E;text-transform:uppercase;letter-spacing:0.8px;margin-bottom:10px;display:flex;align-items:center;gap:6px}
.tc-rows{display:flex;flex-direction:column;gap:4px}
.tc-row{display:flex;justify-content:space-between;font-size:12px;color:#78350F;padding:2px 0}
.tc-row.sub{padding-left:12px;color:#A16207;font-size:11.5px}
.tc-divider{border-top:1px dashed #FDE68A;margin:4px 0}
.tc-total{font-weight:700;font-size:13.5px;color:#78350F}
.tc-schol{margin-top:8px;padding:6px 10px;background:rgba(5,150,105,0.08);border-radius:6px;font-size:11px;color:var(--green);display:flex;align-items:center;gap:5px}
.ch-input{padding:14px 22px;background:var(--card);border-top:1px solid var(--border);flex-shrink:0}
.in-row{display:flex;gap:9px}
.in-box{flex:1;padding:11px 15px;border:1px solid var(--border);border-radius:11px;font-family:'Sora',sans-serif;font-size:13.5px;outline:none;background:var(--bg);transition:border 0.2s}
.in-box:focus{border-color:var(--teal)}
.in-btn{padding:11px 18px;border-radius:11px;border:none;background:var(--navy);color:#fff;font-family:'Sora',sans-serif;font-size:13.5px;font-weight:600;cursor:pointer;transition:background 0.2s;white-space:nowrap}
.in-btn:hover{background:var(--navy-light)}.in-btn:disabled{opacity:0.4;cursor:not-allowed}
.quicks{display:flex;flex-wrap:wrap;gap:7px;margin-top:9px}
.qb{padding:5px 13px;border-radius:18px;border:1px solid var(--border);background:var(--card);font-family:'Sora',sans-serif;font-size:11.5px;color:var(--text-light);cursor:pointer;transition:all 0.2s}
.qb:hover{border-color:var(--teal);color:var(--teal)}
.typing{display:flex;gap:4px;padding:13px 17px;background:var(--card);border:1px solid var(--border);border-radius:16px;border-bottom-left-radius:4px;width:fit-content}
.td{width:6px;height:6px;background:var(--text-muted);border-radius:50%;animation:tb 1.2s infinite}
.td:nth-child(2){animation-delay:0.2s}.td:nth-child(3){animation-delay:0.4s}
@keyframes tb{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-5px)}}
.footer{padding:6px 22px 8px;background:var(--card);border-top:1px solid var(--border);text-align:center;font-size:10px;color:var(--text-muted);flex-shrink:0}
.footer a{color:var(--teal);text-decoration:none}
.err-box{margin:8px 0;padding:12px 16px;background:var(--red-bg);border:1px solid #FECACA;border-radius:10px;color:var(--red);font-size:12px}

/* Homepage v2.1 — Dark Cinematic */
.hp{width:100%;min-height:100vh;background:#0A0F1C;overflow-x:hidden;color:#F0F2F5}

/* Scroll animations */
.hp-anim{opacity:0;transform:translateY(24px);transition:opacity 0.7s ease-out,transform 0.7s ease-out}
.hp-anim.hp-visible{opacity:1;transform:translateY(0)}
.hp-anim-delay-1{transition-delay:0.1s}.hp-anim-delay-2{transition-delay:0.2s}.hp-anim-delay-3{transition-delay:0.3s}.hp-anim-delay-4{transition-delay:0.4s}

/* Sticky nav */
.hp-snav{position:fixed;top:0;left:0;right:0;z-index:100;padding:14px 32px;background:rgba(10,15,28,0.85);backdrop-filter:blur(16px);border-bottom:1px solid rgba(255,255,255,0.06);display:flex;align-items:center;justify-content:space-between;max-width:100%;opacity:0;transform:translateY(-100%);transition:opacity 0.35s,transform 0.35s;pointer-events:none}
.hp-snav.hp-snav-show{opacity:1;transform:translateY(0);pointer-events:all}
.hp-snav-inner{display:flex;align-items:center;justify-content:space-between;max-width:1200px;margin:0 auto;width:100%}
.hp-snav-logo{display:flex;align-items:center;gap:9px}
.hp-snav-sq{width:30px;height:30px;background:linear-gradient(135deg,#00D4FF,#FFB547);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px;color:#fff;font-weight:800}
.hp-snav-t{font-size:17px;font-weight:700;color:#F0F2F5;letter-spacing:-0.3px}
.hp-snav-t .hi{color:#00D4FF}
.hp-snav-links{display:flex;align-items:center;gap:20px}
.hp-snav-link{font-size:13px;color:#94A3B8;background:none;border:none;font-family:'Sora',sans-serif;cursor:pointer;transition:color 0.2s}
.hp-snav-link:hover{color:#00D4FF}
.hp-snav-profile{display:flex;align-items:center;gap:6px;padding:4px 12px;background:rgba(0,212,255,0.06);border:1px solid rgba(0,212,255,0.15);border-radius:20px;cursor:pointer;transition:all 0.2s}
.hp-snav-profile:hover{background:rgba(0,212,255,0.12);border-color:rgba(0,212,255,0.3)}
.hp-snav-flag{font-size:14px}
.hp-snav-name{font-size:12px;color:#00D4FF;font-weight:600}

/* Act 1: The Hook */
.hp-act1{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:40px 32px;background:linear-gradient(170deg,#0A0F1C 0%,#0B1A2E 40%,#0F1629 100%);position:relative;overflow:hidden}
.hp-act1::before{content:'';position:absolute;top:30%;left:50%;width:600px;height:600px;transform:translate(-50%,-50%);background:radial-gradient(circle,rgba(0,212,255,0.04) 0%,transparent 70%);pointer-events:none}
.hp-hook{font-size:64px;font-weight:700;color:#F0F2F5;line-height:1.05;letter-spacing:-2px;margin-bottom:48px;text-shadow:0 0 80px rgba(0,212,255,0.08)}
@media(max-width:768px){.hp-hook{font-size:36px;letter-spacing:-1px;margin-bottom:32px}}
.hp-inline{display:flex;align-items:center;justify-content:center;gap:10px;flex-wrap:wrap;font-size:20px;color:#94A3B8;margin-bottom:36px}
@media(max-width:768px){.hp-inline{font-size:16px;gap:8px}}
.hp-inline-sel{background:transparent;border:none;border-bottom:2px solid rgba(0,212,255,0.3);color:#00D4FF;font-family:'Sora',sans-serif;font-size:20px;font-weight:600;padding:4px 2px;outline:none;cursor:pointer;transition:border-color 0.2s;-webkit-appearance:none;appearance:none}
@media(max-width:768px){.hp-inline-sel{font-size:16px}}
.hp-inline-sel:hover,.hp-inline-sel:focus{border-color:#00D4FF}
.hp-inline-sel option{background:#0A0F1C;color:#F0F2F5;font-size:15px}
.hp-go{padding:16px 40px;border-radius:12px;border:none;background:linear-gradient(135deg,#00D4FF,#0096B4);color:#fff;font-family:'Sora',sans-serif;font-size:17px;font-weight:600;cursor:pointer;transition:all 0.3s;opacity:0;transform:translateY(8px);pointer-events:none}
.hp-go.hp-go-show{opacity:1;transform:translateY(0);pointer-events:all}
.hp-go:hover{transform:translateY(-2px);box-shadow:0 12px 40px rgba(0,212,255,0.3)}
.hp-powered{font-size:13px;color:#64748B;margin-top:40px}

/* Act 2: Data Story */
.hp-act2{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:100px 32px;background:#0F1629;text-align:center;position:relative}
@media(max-width:768px){.hp-act2{padding:64px 20px;min-height:auto}}
.hp-act2-head{font-size:32px;font-weight:600;color:#F0F2F5;margin-bottom:56px;line-height:1.2;letter-spacing:-0.5px}
@media(max-width:768px){.hp-act2-head{font-size:22px;margin-bottom:36px}}
.hp-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:32px;max-width:900px;margin:0 auto 48px}
@media(max-width:768px){.hp-stats{grid-template-columns:repeat(2,1fr);gap:20px}}
.hp-stat{padding:24px 16px}
.hp-stat-val{font-size:48px;font-weight:700;line-height:1;margin-bottom:10px;text-shadow:0 0 40px currentColor}
@media(max-width:768px){.hp-stat-val{font-size:32px}}
.hp-stat-val.teal{color:#00D4FF}.hp-stat-val.green{color:#34D399}.hp-stat-val.amber{color:#FFB547}
.hp-stat-lab{font-size:14px;color:#94A3B8;line-height:1.5}
@media(max-width:768px){.hp-stat-lab{font-size:12px}}
.hp-act2-note{font-size:14px;color:#64748B;max-width:600px;margin:0 auto;line-height:1.6}

/* Act 3: The Stakes */
.hp-act3{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:100px 32px;background:#0A0F1C;text-align:center}
@media(max-width:768px){.hp-act3{padding:64px 20px;min-height:auto}}
.hp-act3-head{font-size:36px;font-weight:700;color:#F0F2F5;margin-bottom:12px;letter-spacing:-0.5px;line-height:1.15}
@media(max-width:768px){.hp-act3-head{font-size:24px}}
.hp-act3-sel{display:flex;align-items:center;justify-content:center;gap:8px;flex-wrap:wrap;font-size:17px;color:#94A3B8;margin-bottom:36px;line-height:1.6}
.hp-act3-sel select{background:transparent;border:none;border-bottom:2px solid rgba(0,212,255,0.3);color:#00D4FF;font-family:'Sora',sans-serif;font-size:17px;font-weight:600;padding:3px 2px;outline:none;cursor:pointer;transition:border-color 0.2s;-webkit-appearance:none;appearance:none}
.hp-act3-sel select:hover,.hp-act3-sel select:focus{border-color:#00D4FF}
.hp-act3-sel select option{background:#0A0F1C;color:#F0F2F5;font-size:14px}
@media(max-width:768px){.hp-act3-sel{font-size:15px;margin-bottom:24px}.hp-act3-sel select{font-size:15px}}
.hp-vmap{position:relative;width:100%;max-width:800px;height:420px;margin:0 auto 48px;border-radius:20px;background:#0F1629;border:1px solid rgba(255,255,255,0.06)}
.hp-vmap::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(135deg,rgba(52,211,153,0.04) 0%,transparent 50%,rgba(248,113,113,0.03) 100%);pointer-events:none}
.hp-vmap-axis{position:absolute;top:8%;left:8%;width:84%;height:84%;border-left:1px dashed rgba(255,255,255,0.06);border-bottom:1px dashed rgba(255,255,255,0.06);pointer-events:none}
.hp-vmap-axis-x{position:absolute;bottom:4%;left:50%;transform:translateX(-50%);font-size:10px;color:#475569;letter-spacing:1px;text-transform:uppercase}
.hp-vmap-axis-y{position:absolute;top:50%;left:2%;transform:translateY(-50%) rotate(-90deg);font-size:10px;color:#475569;letter-spacing:1px;text-transform:uppercase;transform-origin:center}
@media(max-width:768px){.hp-vmap{height:320px}}
.hp-vmap-label{position:absolute;font-size:11px;color:#64748B;font-weight:500;letter-spacing:0.5px}
.hp-vmap-label.tl{top:16px;left:20px}.hp-vmap-label.br{bottom:16px;right:20px}
.hp-vmap-zone{position:absolute;top:10%;left:5%;width:45%;height:45%;background:radial-gradient(ellipse,rgba(52,211,153,0.08) 0%,transparent 70%);border-radius:50%;pointer-events:none}
.hp-vmap-bubble{position:absolute;padding:6px 10px;border-radius:10px;text-align:center;line-height:1.3;opacity:0;transform:scale(0.75) translateY(8px);transition:opacity 0.5s ease-out,transform 0.5s ease-out;cursor:default}
.hp-vmap-bubble.hp-bv{opacity:1;transform:scale(1) translateY(0)}
.hp-vmap-bubble.hp-bv:hover{transform:scale(1.06);z-index:20}
.hp-vmap-bubble.strong{background:rgba(52,211,153,0.20);color:#34D399;border:1px solid rgba(52,211,153,0.35);box-shadow:0 0 20px rgba(52,211,153,0.10)}
.hp-vmap-bubble.good{background:rgba(52,211,153,0.13);color:#6EE7B7;border:1px solid rgba(52,211,153,0.22);box-shadow:0 0 16px rgba(52,211,153,0.06)}
.hp-vmap-bubble.avg{background:rgba(255,181,71,0.13);color:#FFB547;border:1px solid rgba(255,181,71,0.22);box-shadow:0 0 16px rgba(255,181,71,0.05)}
.hp-vmap-bubble.poor{background:rgba(248,113,113,0.13);color:#F87171;border:1px solid rgba(248,113,113,0.22);box-shadow:0 0 16px rgba(248,113,113,0.05)}
.hp-vmap-bubble .bname{font-size:12px;font-weight:700;white-space:nowrap}
.hp-vmap-bubble .broi-tag{font-size:10px;opacity:0.8;font-weight:500;margin-top:2px}
.hp-vmap-tip{position:absolute;bottom:calc(100% + 10px);left:50%;transform:translateX(-50%);width:240px;background:#131B2E;border:1px solid rgba(0,212,255,0.2);border-radius:12px;padding:14px 16px;text-align:left;opacity:0;pointer-events:none;transition:opacity 0.2s;z-index:30;box-shadow:0 8px 32px rgba(0,0,0,0.4)}
.hp-vmap-bubble:hover .hp-vmap-tip{opacity:1}
.hp-vmap-tip-uni{font-size:13px;font-weight:700;color:#F0F2F5;margin-bottom:2px}
.hp-vmap-tip-prog{font-size:11px;color:#94A3B8;margin-bottom:10px}
.hp-vmap-tip-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px 12px;margin-bottom:10px}
.hp-vmap-tip-label{font-size:10px;color:#64748B;text-transform:uppercase;letter-spacing:0.5px}
.hp-vmap-tip-val{font-size:13px;font-weight:600;color:#F0F2F5}
.hp-vmap-tip-payback{font-size:11px;color:#00D4FF;font-weight:500;border-top:1px solid rgba(255,255,255,0.06);padding-top:8px}
.hp-vmap-empty{display:flex;align-items:center;justify-content:center;height:100%;color:#475569;font-size:15px;text-align:center;padding:0 32px}
.hp-vmap-note{font-size:11px;color:#475569;text-align:center;max-width:800px;margin:0 auto;line-height:1.5;padding:0 20px}
@media(max-width:768px){.hp-vmap-bubble{padding:5px 8px;border-radius:8px}.hp-vmap-bubble .bname{font-size:10px}.hp-vmap-bubble .broi-tag{font-size:9px}.hp-vmap-tip{width:200px;padding:10px 12px;left:0;transform:none}}
.hp-act3-big{font-size:22px;font-weight:600;color:#F0F2F5;margin-bottom:16px;line-height:1.3}
@media(max-width:768px){.hp-act3-big{font-size:17px}}
.hp-act3-sub{font-size:16px;color:#94A3B8;line-height:1.6}
@media(max-width:768px){.hp-act3-sub{font-size:14px}}

/* Act 4: The Platform */
.hp-act4{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:100px 32px;background:#0F1629;text-align:center}
@media(max-width:768px){.hp-act4{padding:64px 20px;min-height:auto}}
.hp-act4-head{font-size:36px;font-weight:700;color:#F0F2F5;margin-bottom:64px;letter-spacing:-0.5px}
@media(max-width:768px){.hp-act4-head{font-size:24px;margin-bottom:40px}}
.hp-journey{display:flex;align-items:flex-start;gap:0;max-width:1000px;margin:0 auto;position:relative}
@media(max-width:768px){.hp-journey{flex-direction:column;gap:0;align-items:stretch}}
.hp-phase{flex:1;text-align:center;position:relative;padding:0 12px}
@media(max-width:768px){.hp-phase{display:flex;align-items:flex-start;gap:16px;text-align:left;padding:0 0 32px}}
.hp-phase-dot{width:16px;height:16px;border-radius:50%;background:#00D4FF;margin:0 auto 12px;position:relative;z-index:2;box-shadow:0 0 20px rgba(0,212,255,0.3)}
@media(max-width:768px){.hp-phase-dot{margin:4px 0 0;flex-shrink:0}}
.hp-phase.dim .hp-phase-dot{background:#64748B;box-shadow:none}
.hp-phase-line{position:absolute;top:8px;left:calc(50% + 8px);right:calc(-50% + 8px);height:2px;background:rgba(0,212,255,0.15);z-index:1}
@media(max-width:768px){.hp-phase-line{display:none}}
.hp-phase:last-child .hp-phase-line{display:none}
.hp-phase-content{position:relative}
@media(max-width:768px){.hp-phase-content{flex:1}}
.hp-phase-name{font-size:14px;font-weight:600;color:#F0F2F5;margin-bottom:6px}
.hp-phase.dim .hp-phase-name{color:#64748B}
.hp-phase-desc{font-size:12px;color:#94A3B8;line-height:1.5}
.hp-phase.dim .hp-phase-desc{color:#4A5568}
.hp-phase-badge{display:inline-block;font-size:10px;color:#64748B;border:1px solid rgba(255,255,255,0.06);border-radius:4px;padding:2px 6px;margin-top:6px;font-weight:500}

/* Act 5: Social Proof */
.hp-act5{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:100px 32px;background:#0A0F1C;text-align:center}
@media(max-width:768px){.hp-act5{padding:64px 20px;min-height:auto}}
.hp-act5-head{font-size:32px;font-weight:600;color:#F0F2F5;margin-bottom:56px;letter-spacing:-0.5px}
@media(max-width:768px){.hp-act5-head{font-size:22px;margin-bottom:36px}}
.hp-data-cards{display:grid;grid-template-columns:repeat(3,1fr);gap:24px;max-width:900px;margin:0 auto 56px;width:100%}
@media(max-width:768px){.hp-data-cards{grid-template-columns:1fr;gap:16px}}
.hp-data-card{background:#151C2F;border:1px solid rgba(255,255,255,0.06);border-radius:16px;padding:32px 24px;transition:border-color 0.3s,box-shadow 0.3s}
.hp-data-card:hover{border-color:rgba(0,212,255,0.3);box-shadow:0 0 30px rgba(0,212,255,0.06)}
.hp-data-val{font-size:40px;font-weight:700;margin-bottom:8px;line-height:1}
@media(max-width:768px){.hp-data-val{font-size:32px}}
.hp-data-val.teal{color:#00D4FF}.hp-data-val.amber{color:#FFB547}.hp-data-val.green{color:#34D399}
.hp-data-lab{font-size:14px;color:#94A3B8;line-height:1.5}
.hp-quotes{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;max-width:900px;margin:0 auto 24px;width:100%}
@media(max-width:768px){.hp-quotes{grid-template-columns:1fr;gap:14px}}
.hp-quote{background:#151C2F;border:1px solid rgba(255,255,255,0.06);border-radius:14px;padding:24px;text-align:left}
.hp-quote-text{font-size:14px;color:#94A3B8;line-height:1.7;margin-bottom:14px;font-style:italic}
.hp-quote-who{font-size:12px;color:#64748B}
.hp-disc{font-size:11px;color:#4A5568;font-style:italic}

/* Act 6: Final CTA */
.hp-act6{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:40px 32px;background:linear-gradient(170deg,#0F1629 0%,#0A0F1C 100%);position:relative}
.hp-act6::before{content:'';position:absolute;top:40%;left:50%;width:500px;height:500px;transform:translate(-50%,-50%);background:radial-gradient(circle,rgba(0,212,255,0.05) 0%,transparent 70%);pointer-events:none}
.hp-act6-head{font-size:48px;font-weight:700;color:#F0F2F5;letter-spacing:-1px;margin-bottom:36px;position:relative;z-index:1}
@media(max-width:768px){.hp-act6-head{font-size:30px}}
.hp-act6-btn{padding:18px 48px;border-radius:14px;border:none;background:linear-gradient(135deg,#00D4FF,#0096B4);color:#fff;font-family:'Sora',sans-serif;font-size:18px;font-weight:600;cursor:pointer;transition:all 0.3s;position:relative;z-index:1;box-shadow:0 0 40px rgba(0,212,255,0.15)}
.hp-act6-btn:hover{transform:translateY(-2px);box-shadow:0 16px 48px rgba(0,212,255,0.3)}
.hp-act6-muted{font-size:14px;color:#64748B;margin-top:24px;position:relative;z-index:1}
.hp-act6-parent{font-size:14px;color:#94A3B8;margin-top:12px;position:relative;z-index:1;cursor:pointer;background:none;border:none;font-family:'Sora',sans-serif;transition:color 0.2s}
.hp-act6-parent:hover{color:#00D4FF}

/* Footer */
.hp-footer{background:#0A0F1C;border-top:1px solid rgba(255,255,255,0.06);padding:40px 32px;text-align:center}
.hp-footer-brand{font-size:13px;color:#4A5568;margin-bottom:6px}
.hp-footer-note{font-size:11px;color:#374151;line-height:1.5}

/* Profile Builder */
.pb{width:100%;min-height:100vh;background:#0A0F1C;color:#F0F2F5;display:flex;flex-direction:column;font-family:'Sora',sans-serif;overflow:hidden}
.pb-bar{position:fixed;top:0;left:0;right:0;height:4px;background:rgba(255,255,255,0.06);z-index:100}
.pb-fill{height:100%;background:linear-gradient(90deg,#00D4FF,#0096B4);border-radius:0 2px 2px 0;transition:width 0.4s ease}
.pb-top{position:fixed;top:4px;left:0;right:0;padding:16px 24px;display:flex;align-items:center;justify-content:space-between;z-index:99;background:rgba(10,15,28,0.8);backdrop-filter:blur(12px)}
.pb-back{background:none;border:none;color:#94A3B8;font-family:'Sora',sans-serif;font-size:14px;cursor:pointer;padding:6px 12px;border-radius:8px;transition:all 0.2s;display:flex;align-items:center;gap:6px}
.pb-back:hover{color:#F0F2F5;background:rgba(255,255,255,0.06)}
.pb-step-count{font-size:13px;color:#64748B;font-weight:500}
.pb-logo{display:flex;align-items:center;gap:8px;font-size:15px;font-weight:700;color:#F0F2F5;letter-spacing:-0.3px}
.pb-logo .hi{color:#00D4FF}
.pb-logo-sq{width:26px;height:26px;background:linear-gradient(135deg,#00D4FF,#FFB547);border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:12px;color:#fff;font-weight:800}
.pb-body{flex:1;display:flex;align-items:center;justify-content:center;padding:100px 32px 60px;position:relative}
.pb-slide{width:100%;max-width:640px;margin:0 auto;animation:pbSlideIn 0.35s ease-out}
@keyframes pbSlideIn{from{opacity:0;transform:translateX(40px)}to{opacity:1;transform:translateX(0)}}
.pb-q{font-size:32px;font-weight:700;color:#F0F2F5;margin-bottom:12px;line-height:1.2;letter-spacing:-0.5px}
@media(max-width:768px){.pb-q{font-size:24px}}
.pb-helper{font-size:14px;color:#94A3B8;margin-bottom:40px;line-height:1.5;max-width:520px}
.pb-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px}
.pb-grid-3{grid-template-columns:repeat(3,1fr)}
.pb-grid-2{grid-template-columns:repeat(2,1fr)}
@media(max-width:768px){.pb-grid{grid-template-columns:repeat(2,1fr)}.pb-grid-3,.pb-grid-2{grid-template-columns:1fr}}
.pb-card{padding:20px 16px;border-radius:14px;background:#0F1629;border:1.5px solid rgba(255,255,255,0.06);cursor:pointer;text-align:center;transition:all 0.2s;display:flex;flex-direction:column;align-items:center;gap:6px}
.pb-card:hover{border-color:rgba(0,212,255,0.25);background:#131B2E}
.pb-card.on{border-color:#00D4FF;background:rgba(0,212,255,0.08);box-shadow:0 0 24px rgba(0,212,255,0.12)}
.pb-card-emoji{font-size:28px}
.pb-card-label{font-size:14px;font-weight:600;color:#F0F2F5}
.pb-card-sub{font-size:11px;color:#94A3B8}
.pb-input{width:100%;padding:16px 20px;border-radius:12px;background:#0F1629;border:1.5px solid rgba(255,255,255,0.08);color:#F0F2F5;font-family:'Sora',sans-serif;font-size:16px;outline:none;transition:border-color 0.2s}
.pb-input:focus{border-color:#00D4FF}
.pb-input::placeholder{color:#475569}
.pb-chips{display:flex;flex-wrap:wrap;gap:10px}
.pb-chip{padding:10px 18px;border-radius:24px;border:1.5px solid rgba(255,255,255,0.08);background:#0F1629;color:#94A3B8;font-family:'Sora',sans-serif;font-size:13px;font-weight:500;cursor:pointer;transition:all 0.2s}
.pb-chip:hover{border-color:rgba(0,212,255,0.25);color:#CBD5E1}
.pb-chip.on{border-color:#00D4FF;background:rgba(0,212,255,0.08);color:#00D4FF}
.pb-pills{display:flex;flex-wrap:wrap;gap:8px;margin-top:20px}
.pb-pill{padding:8px 16px;border-radius:20px;border:1px solid rgba(255,255,255,0.06);background:#0F1629;color:#94A3B8;font-family:'Sora',sans-serif;font-size:12px;cursor:pointer;transition:all 0.2s}
.pb-pill:hover{border-color:rgba(0,212,255,0.2)}
.pb-pill.on{border-color:#00D4FF;background:rgba(0,212,255,0.06);color:#00D4FF}
.pb-score-row{display:flex;align-items:center;gap:12px;margin-top:16px}
.pb-score-input{width:80px;padding:12px 16px;border-radius:10px;background:#0F1629;border:1.5px solid rgba(255,255,255,0.08);color:#F0F2F5;font-family:'Sora',sans-serif;font-size:18px;font-weight:600;text-align:center;outline:none}
.pb-score-input:focus{border-color:#00D4FF}
.pb-score-label{font-size:13px;color:#64748B}
.pb-next{margin-top:40px;padding:14px 36px;border-radius:12px;border:none;background:linear-gradient(135deg,#00D4FF,#0096B4);color:#fff;font-family:'Sora',sans-serif;font-size:16px;font-weight:600;cursor:pointer;transition:all 0.3s;opacity:0.4;pointer-events:none}
.pb-next.ready{opacity:1;pointer-events:all}
.pb-next.ready:hover{transform:translateY(-2px);box-shadow:0 12px 36px rgba(0,212,255,0.25)}
.pb-skip{background:none;border:none;color:#64748B;font-family:'Sora',sans-serif;font-size:13px;cursor:pointer;margin-top:16px;transition:color 0.2s}
.pb-skip:hover{color:#94A3B8}
.pb-sub-q{font-size:15px;color:#94A3B8;margin-top:28px;margin-bottom:12px;font-weight:500}
.pb-summary{max-width:520px;margin:0 auto;padding:32px;border-radius:20px;background:#0F1629;border:1px solid rgba(0,212,255,0.15);box-shadow:0 8px 40px rgba(0,0,0,0.3)}
.pb-summary-row{display:flex;justify-content:space-between;align-items:flex-start;padding:12px 0;border-bottom:1px solid rgba(255,255,255,0.04)}
.pb-summary-row:last-child{border-bottom:none}
.pb-summary-label{font-size:12px;color:#64748B;text-transform:uppercase;letter-spacing:0.5px;flex-shrink:0}
.pb-summary-val{font-size:14px;color:#F0F2F5;font-weight:500;text-align:right}
.pb-launch{margin-top:32px;padding:16px 48px;border-radius:14px;border:none;background:linear-gradient(135deg,#00D4FF,#0096B4);color:#fff;font-family:'Sora',sans-serif;font-size:17px;font-weight:600;cursor:pointer;transition:all 0.3s;width:100%}
.pb-launch:hover{transform:translateY(-2px);box-shadow:0 16px 48px rgba(0,212,255,0.3)}
.pb-edit{margin-top:12px;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.08);background:transparent;color:#94A3B8;font-family:'Sora',sans-serif;font-size:14px;cursor:pointer;transition:all 0.2s;width:100%}
.pb-edit:hover{border-color:rgba(0,212,255,0.2);color:#F0F2F5}
.pb-bonus{margin-top:24px;padding:20px;border-radius:14px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.04)}
.pb-bonus-q{font-size:14px;color:#94A3B8;margin-bottom:10px}
.pb-bonus-row{display:flex;gap:10px;align-items:center}
.pb-bonus-btn{padding:8px 18px;border-radius:20px;border:1px solid rgba(255,255,255,0.06);background:#0F1629;color:#94A3B8;font-family:'Sora',sans-serif;font-size:13px;cursor:pointer;transition:all 0.2s}
.pb-bonus-btn.on{border-color:#00D4FF;background:rgba(0,212,255,0.06);color:#00D4FF}
.pb-bonus-input{flex:1;padding:8px 14px;border-radius:10px;background:#0F1629;border:1px solid rgba(255,255,255,0.06);color:#F0F2F5;font-family:'Sora',sans-serif;font-size:13px;outline:none}

/* Dashboard */
.db{width:100%;min-height:100vh;background:#0A0F1C;color:#F0F2F5;font-family:'Sora',sans-serif}

/* Dashboard header */
.db-hdr{position:sticky;top:0;z-index:80;background:rgba(10,15,28,0.92);backdrop-filter:blur(16px);border-bottom:1px solid rgba(255,255,255,0.06)}
.db-hdr-inner{max-width:1200px;margin:0 auto;padding:14px 32px;display:flex;align-items:center;justify-content:space-between}
.db-hdr-left{display:flex;align-items:center;gap:14px}
.db-hdr-logo{display:flex;align-items:center;gap:8px}
.db-hdr-logo-sq{width:30px;height:30px;background:linear-gradient(135deg,#00D4FF,#FFB547);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px;color:#fff;font-weight:800}
.db-hdr-logo-t{font-size:17px;font-weight:700;color:#F0F2F5;letter-spacing:-0.3px}
.db-hdr-logo-t .hi{color:#00D4FF}
.db-hdr-stu{display:flex;align-items:center;gap:8px;padding:4px 12px;background:rgba(255,255,255,0.04);border-radius:8px;font-size:12px;color:#94A3B8}
.db-hdr-flag{font-size:16px}
.db-hdr-right{display:flex;align-items:center;gap:12px}
.db-hdr-btn{padding:7px 16px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:transparent;color:#94A3B8;font-family:'Sora',sans-serif;font-size:12px;font-weight:500;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;gap:6px}
.db-hdr-btn:hover{border-color:rgba(0,212,255,0.3);color:#F0F2F5}
.db-hdr-edit{width:32px;height:32px;border-radius:8px;border:1px solid rgba(255,255,255,0.08);background:transparent;color:#94A3B8;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;transition:all 0.2s}
.db-hdr-edit:hover{border-color:rgba(0,212,255,0.3);color:#F0F2F5}
@media(max-width:768px){.db-hdr-inner{flex-wrap:wrap;gap:10px;padding:12px 16px}.db-hdr-right{display:none}}

/* Tab navigation */
.db-tabs-wrap{background:rgba(15,22,41,0.6);border-bottom:1px solid rgba(255,255,255,0.06)}
.db-tabs{max-width:1200px;margin:0 auto;padding:0 32px;display:flex;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none}
.db-tabs::-webkit-scrollbar{display:none}
.db-tab{padding:14px 20px;font-size:13px;font-weight:600;color:#64748B;cursor:pointer;border-bottom:2px solid transparent;transition:all 0.2s;white-space:nowrap;background:none;border-top:none;border-left:none;border-right:none;font-family:'Sora',sans-serif;letter-spacing:0.3px}
.db-tab:hover{color:#94A3B8}
.db-tab.on{color:#00D4FF;border-bottom-color:#00D4FF}
@media(max-width:768px){.db-tabs{padding:0 16px}.db-tab{padding:12px 16px;font-size:12px}}

/* Feature buttons row */
.db-feats{max-width:1200px;margin:0 auto;padding:20px 32px 4px;display:flex;gap:10px;flex-wrap:wrap}
.db-feat{padding:10px 20px;border-radius:10px;border:1px solid rgba(255,255,255,0.08);background:rgba(15,22,41,0.5);color:#94A3B8;font-family:'Sora',sans-serif;font-size:13px;font-weight:500;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;gap:8px}
.db-feat:hover{border-color:rgba(0,212,255,0.25);color:#F0F2F5;background:rgba(0,212,255,0.04)}
.db-feat-icon{font-size:15px}
@media(max-width:768px){.db-feats{padding:14px 16px 4px;gap:8px}.db-feat{padding:8px 14px;font-size:12px}}

/* Dashboard content area */
.db-content{max-width:1200px;margin:0 auto;padding:28px 32px 80px}
@media(max-width:768px){.db-content{padding:20px 16px 80px}}
.db-content-head{font-size:28px;font-weight:700;color:#F0F2F5;margin-bottom:6px;letter-spacing:-0.5px}
@media(max-width:768px){.db-content-head{font-size:22px}}
.db-content-sub{font-size:14px;color:#94A3B8;margin-bottom:32px;line-height:1.5}

/* Match cards */
.db-matches{display:flex;flex-direction:column;gap:16px}
.db-match{background:#0F1629;border:1.5px solid rgba(255,255,255,0.06);border-radius:16px;overflow:hidden;transition:all 0.3s;animation:dbCardIn 0.5s ease-out both}
.db-match:hover{border-color:rgba(0,212,255,0.2);box-shadow:0 8px 36px rgba(0,212,255,0.06)}
@keyframes dbCardIn{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
.db-match:nth-child(2){animation-delay:0.08s}.db-match:nth-child(3){animation-delay:0.16s}.db-match:nth-child(4){animation-delay:0.24s}.db-match:nth-child(5){animation-delay:0.32s}.db-match:nth-child(6){animation-delay:0.40s}.db-match:nth-child(7){animation-delay:0.48s}.db-match:nth-child(8){animation-delay:0.56s}

/* Match card top section */
.db-m-top{padding:20px 24px 16px;display:flex;gap:20px;align-items:flex-start}
@media(max-width:768px){.db-m-top{flex-direction:column;padding:16px;gap:12px}}
.db-m-info{flex:1;min-width:0}
.db-m-uni{font-size:11px;font-weight:600;color:#00D4FF;text-transform:uppercase;letter-spacing:0.8px;margin-bottom:4px}
.db-m-name{font-size:18px;font-weight:700;color:#F0F2F5;margin-bottom:8px;line-height:1.3}
.db-m-meta{display:flex;align-items:center;gap:6px;flex-wrap:wrap;font-size:12px;color:#94A3B8;margin-bottom:10px}
.db-m-meta-sep{color:#374151}
.db-m-tags{display:flex;flex-wrap:wrap;gap:6px}
.db-m-tag{font-size:11px;padding:3px 10px;border-radius:6px;font-weight:500}
.db-m-tag.fee{background:rgba(255,181,71,0.12);color:#FFB547}
.db-m-tag.city{background:rgba(0,212,255,0.08);color:#00D4FF}
.db-m-tag.dur{background:rgba(168,85,247,0.12);color:#A855F7}
.db-m-tag.fnd{background:rgba(52,211,153,0.12);color:#34D399}

/* Readiness circle */
.db-m-ready{flex-shrink:0;display:flex;flex-direction:column;align-items:center;gap:6px}
.db-m-circle{width:72px;height:72px;position:relative}
.db-m-circle svg{width:72px;height:72px;transform:rotate(-90deg)}
.db-m-circle-bg{fill:none;stroke:rgba(255,255,255,0.06);stroke-width:5}
.db-m-circle-fg{fill:none;stroke-width:5;stroke-linecap:round;transition:stroke-dashoffset 1s ease-out}
.db-m-circle-fg.green{stroke:#34D399}.db-m-circle-fg.amber{stroke:#FFB547}.db-m-circle-fg.red{stroke:#F87171}
.db-m-circle-val{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:18px;font-weight:700;color:#F0F2F5}
.db-m-ready-label{font-size:10px;color:#64748B;text-transform:uppercase;letter-spacing:0.5px;font-weight:600}

/* Eligibility badge */
.db-m-elig{margin:0 24px;padding:8px 14px;border-radius:8px;font-size:12px;font-weight:600;display:flex;align-items:center;gap:8px}
@media(max-width:768px){.db-m-elig{margin:0 16px}}
.db-m-elig.direct{background:rgba(52,211,153,0.08);color:#34D399;border:1px solid rgba(52,211,153,0.15)}
.db-m-elig.cond{background:rgba(255,181,71,0.08);color:#FFB547;border:1px solid rgba(255,181,71,0.15)}
.db-m-elig.below{background:rgba(248,113,113,0.08);color:#F87171;border:1px solid rgba(248,113,113,0.15)}
.db-m-elig.unk{background:rgba(148,163,184,0.08);color:#94A3B8;border:1px solid rgba(148,163,184,0.1)}

/* Expandable panel tabs */
.db-m-tabs{display:flex;border-top:1px solid rgba(255,255,255,0.04);border-bottom:1px solid rgba(255,255,255,0.04);margin-top:12px}
.db-m-tab{flex:1;padding:10px;text-align:center;font-size:11px;font-weight:600;color:#64748B;cursor:pointer;transition:all 0.2s;letter-spacing:0.5px;background:none;border:none;border-bottom:2px solid transparent;font-family:'Sora',sans-serif;text-transform:uppercase}
.db-m-tab:hover{color:#94A3B8}
.db-m-tab.on{color:#00D4FF;border-bottom-color:#00D4FF}

/* Panel content */
.db-m-panel{padding:16px 24px 20px}
@media(max-width:768px){.db-m-panel{padding:14px 16px 16px}}
.db-m-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
@media(max-width:768px){.db-m-stats{grid-template-columns:repeat(2,1fr)}}
.db-m-stat{text-align:center;padding:8px}
.db-m-stat-val{font-size:22px;font-weight:700;color:#F0F2F5;margin-bottom:4px}
.db-m-stat-val.teal{color:#00D4FF}.db-m-stat-val.green{color:#34D399}.db-m-stat-val.amber{color:#FFB547}
.db-m-stat-label{font-size:10px;color:#64748B;text-transform:uppercase;letter-spacing:0.5px}

/* Students Like Me panel */
.db-m-slm{background:rgba(52,211,153,0.04);border:1px solid rgba(52,211,153,0.1);border-radius:12px;padding:16px}
.db-m-slm-head{font-size:11px;font-weight:700;color:#34D399;text-transform:uppercase;letter-spacing:0.8px;margin-bottom:12px;display:flex;align-items:center;gap:6px}
.db-m-slm-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:12px}
.db-m-slm-stat{text-align:center}
.db-m-slm-val{font-size:18px;font-weight:700;color:#34D399}
.db-m-slm-lab{font-size:9px;color:#6EE7B7;text-transform:uppercase;letter-spacing:0.5px}
.db-m-slm-note{font-size:12px;color:#6EE7B7;line-height:1.5;font-style:italic}

/* Total Cost panel */
.db-m-cost{background:rgba(255,181,71,0.04);border:1px solid rgba(255,181,71,0.1);border-radius:12px;padding:16px}
.db-m-cost-head{font-size:11px;font-weight:700;color:#FFB547;text-transform:uppercase;letter-spacing:0.8px;margin-bottom:12px;display:flex;align-items:center;gap:6px}
.db-m-cost-rows{display:flex;flex-direction:column;gap:3px}
.db-m-cost-row{display:flex;justify-content:space-between;font-size:12px;color:#CBD5E1;padding:3px 0}
.db-m-cost-row.sub{padding-left:12px;color:#94A3B8;font-size:11px}
.db-m-cost-div{border-top:1px dashed rgba(255,181,71,0.15);margin:5px 0}
.db-m-cost-total{font-weight:700;font-size:14px;color:#FFB547}
.db-m-cost-schol{margin-top:10px;padding:8px 12px;background:rgba(52,211,153,0.06);border-radius:8px;font-size:11px;color:#34D399;display:flex;align-items:center;gap:6px}

/* Action row */
.db-m-actions{display:flex;flex-wrap:wrap;gap:0;border-top:1px solid rgba(255,255,255,0.04);padding:0}
.db-m-action{flex:1;min-width:0;padding:12px;text-align:center;font-size:11px;font-weight:600;color:#64748B;cursor:pointer;transition:all 0.2s;background:none;border:none;border-right:1px solid rgba(255,255,255,0.04);font-family:'Sora',sans-serif}
.db-m-action:last-child{border-right:none}
.db-m-action:hover{color:#00D4FF;background:rgba(0,212,255,0.03)}
@media(max-width:768px){.db-m-actions{flex-direction:column}.db-m-action{border-right:none;border-bottom:1px solid rgba(255,255,255,0.04);text-align:left;padding:12px 16px}.db-m-action:last-child{border-bottom:none}}

/* Floating chat button */
.db-chat-fab{position:fixed;bottom:24px;right:24px;z-index:90;padding:14px 24px;border-radius:50px;border:none;background:linear-gradient(135deg,#00D4FF,#0096B4);color:#fff;font-family:'Sora',sans-serif;font-size:14px;font-weight:600;cursor:pointer;transition:all 0.3s;box-shadow:0 8px 32px rgba(0,212,255,0.3);display:flex;align-items:center;gap:8px;animation:fabPulse 3s ease-in-out infinite}
.db-chat-fab:hover{transform:translateY(-3px);box-shadow:0 14px 44px rgba(0,212,255,0.4)}
@keyframes fabPulse{0%,100%{box-shadow:0 8px 32px rgba(0,212,255,0.3)}50%{box-shadow:0 8px 32px rgba(0,212,255,0.15)}}
@media(max-width:768px){.db-chat-fab{bottom:16px;right:16px;padding:12px 18px;font-size:13px}}

/* Placeholder tab content */
.db-placeholder-tab{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:400px;text-align:center;padding:40px}
.db-placeholder-tab-icon{font-size:48px;margin-bottom:16px}
.db-placeholder-tab-title{font-size:22px;font-weight:700;color:#F0F2F5;margin-bottom:8px}
.db-placeholder-tab-sub{font-size:14px;color:#64748B;line-height:1.6;max-width:400px}

/* Apply / Personal Statement Builder */
.ps{width:100%;min-height:100vh;background:#0A0F1C;color:#F0F2F5;font-family:'Sora',sans-serif;display:flex;flex-direction:column}

/* PS Header */
.ps-hdr{position:sticky;top:0;z-index:80;background:rgba(10,15,28,0.92);backdrop-filter:blur(16px);border-bottom:1px solid rgba(255,255,255,0.06);padding:14px 32px;display:flex;align-items:center;justify-content:space-between}
.ps-hdr-left{display:flex;align-items:center;gap:14px}
.ps-hdr-logo{display:flex;align-items:center;gap:8px;font-size:15px;font-weight:700;color:#F0F2F5}
.ps-hdr-logo .hi{color:#00D4FF}
.ps-hdr-logo-sq{width:26px;height:26px;background:linear-gradient(135deg,#00D4FF,#FFB547);border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:12px;color:#fff;font-weight:800}
.ps-hdr-badge{font-size:11px;color:#00D4FF;background:rgba(0,212,255,0.08);padding:4px 10px;border-radius:6px;font-weight:600;letter-spacing:0.3px}
.ps-hdr-back{background:none;border:1px solid rgba(255,255,255,0.1);color:#94A3B8;padding:7px 16px;border-radius:8px;font-family:'Sora',sans-serif;font-size:12px;font-weight:500;cursor:pointer;transition:all 0.2s}
.ps-hdr-back:hover{border-color:rgba(0,212,255,0.3);color:#F0F2F5}
@media(max-width:768px){.ps-hdr{padding:12px 16px}.ps-hdr-badge{display:none}}

/* Stage progress bar */
.ps-stages{max-width:800px;margin:28px auto 0;padding:0 32px;display:flex;align-items:center;gap:0;width:100%}
.ps-stage{display:flex;align-items:center;gap:8px;flex:1}
.ps-stage-dot{width:28px;height:28px;border-radius:50%;background:#1E2844;border:2px solid rgba(255,255,255,0.08);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#64748B;transition:all 0.3s;flex-shrink:0}
.ps-stage.active .ps-stage-dot{background:#00D4FF;border-color:#00D4FF;color:#fff;box-shadow:0 0 16px rgba(0,212,255,0.3)}
.ps-stage.done .ps-stage-dot{background:#34D399;border-color:#34D399;color:#fff}
.ps-stage-label{font-size:12px;color:#64748B;font-weight:500;white-space:nowrap}
.ps-stage.active .ps-stage-label{color:#F0F2F5}
.ps-stage.done .ps-stage-label{color:#34D399}
.ps-stage-line{flex:1;height:2px;background:rgba(255,255,255,0.06);margin:0 8px}
.ps-stage.done .ps-stage-line{background:#34D399}
@media(max-width:768px){.ps-stages{padding:0 16px;margin-top:20px}.ps-stage-label{font-size:10px}}

/* PS Content area */
.ps-body{flex:1;max-width:800px;width:100%;margin:0 auto;padding:24px 32px 40px;display:flex;flex-direction:column}
@media(max-width:768px){.ps-body{padding:16px 16px 32px}}

/* Stage 1: Chat */
.ps-chat{flex:1;display:flex;flex-direction:column;min-height:0}
.ps-chat-msgs{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:14px;padding:8px 0 20px}
.ps-chat-msg{max-width:88%;animation:fadeUp 0.3s ease}
.ps-chat-msg.ai{align-self:flex-start}.ps-chat-msg.user{align-self:flex-end}
.ps-chat-who{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.8px;margin-bottom:4px;color:#64748B}
.ps-chat-msg.user .ps-chat-who{text-align:right}
.ps-chat-bubble{padding:14px 18px;border-radius:16px;font-size:14px;line-height:1.7}
.ps-chat-msg.ai .ps-chat-bubble{background:#0F1629;border:1px solid rgba(255,255,255,0.06);border-bottom-left-radius:4px}
.ps-chat-msg.user .ps-chat-bubble{background:rgba(0,212,255,0.08);border:1px solid rgba(0,212,255,0.15);border-bottom-right-radius:4px;color:#CBD5E1}
.ps-chat-input{display:flex;gap:10px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.06)}
.ps-chat-input input{flex:1;padding:14px 18px;border-radius:12px;background:#0F1629;border:1.5px solid rgba(255,255,255,0.08);color:#F0F2F5;font-family:'Sora',sans-serif;font-size:14px;outline:none;transition:border-color 0.2s}
.ps-chat-input input:focus{border-color:#00D4FF}
.ps-chat-input input::placeholder{color:#475569}
.ps-chat-input button{padding:14px 24px;border-radius:12px;border:none;background:linear-gradient(135deg,#00D4FF,#0096B4);color:#fff;font-family:'Sora',sans-serif;font-size:14px;font-weight:600;cursor:pointer;transition:all 0.2s;white-space:nowrap}
.ps-chat-input button:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(0,212,255,0.25)}
.ps-chat-input button:disabled{opacity:0.4;cursor:not-allowed;transform:none;box-shadow:none}
.ps-chat-typing{display:flex;gap:4px;padding:14px 18px;background:#0F1629;border:1px solid rgba(255,255,255,0.06);border-radius:16px;border-bottom-left-radius:4px;width:fit-content}
.ps-chat-typing span{width:6px;height:6px;background:#64748B;border-radius:50%;animation:tb 1.2s infinite}
.ps-chat-typing span:nth-child(2){animation-delay:0.2s}
.ps-chat-typing span:nth-child(3){animation-delay:0.4s}

/* Generate button (transition from stage 1 to 2) */
.ps-generate{margin-top:16px;text-align:center}
.ps-generate-btn{padding:16px 40px;border-radius:14px;border:none;background:linear-gradient(135deg,#00D4FF,#0096B4);color:#fff;font-family:'Sora',sans-serif;font-size:16px;font-weight:600;cursor:pointer;transition:all 0.3s;box-shadow:0 0 24px rgba(0,212,255,0.15)}
.ps-generate-btn:hover{transform:translateY(-2px);box-shadow:0 12px 40px rgba(0,212,255,0.3)}
.ps-generate-btn:disabled{opacity:0.4;cursor:not-allowed;transform:none;box-shadow:none}
.ps-generate-note{font-size:12px;color:#64748B;margin-top:10px}

/* Stage 2 & 3: Editor */
.ps-editor{flex:1;display:flex;flex-direction:column;gap:16px}
.ps-editor-head{font-size:22px;font-weight:700;margin-bottom:4px}
.ps-editor-sub{font-size:13px;color:#94A3B8;margin-bottom:8px;line-height:1.5}

/* Character/line counter */
.ps-counter{display:flex;align-items:center;gap:20px;padding:10px 16px;background:#0F1629;border-radius:10px;border:1px solid rgba(255,255,255,0.06);font-size:13px}
.ps-counter-item{display:flex;align-items:center;gap:6px}
.ps-counter-label{color:#64748B;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;font-weight:600}
.ps-counter-val{font-weight:700;font-size:14px;transition:color 0.2s}
.ps-counter-val.green{color:#34D399}
.ps-counter-val.amber{color:#FFB547}
.ps-counter-val.red{color:#F87171}
.ps-counter-val.over{color:#DC2626;animation:counterPulse 0.5s ease}
@keyframes counterPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.15)}}
.ps-counter-limit{color:#475569;font-size:11px}
.ps-counter-bar{flex:1;height:4px;background:rgba(255,255,255,0.06);border-radius:2px;overflow:hidden}
.ps-counter-fill{height:100%;border-radius:2px;transition:width 0.3s,background 0.3s}

/* Textarea */
.ps-textarea{flex:1;min-height:320px;padding:20px;border-radius:14px;background:#0F1629;border:1.5px solid rgba(255,255,255,0.08);color:#F0F2F5;font-family:'Sora',sans-serif;font-size:14px;line-height:1.7;resize:vertical;outline:none;transition:border-color 0.2s}
.ps-textarea:focus{border-color:rgba(0,212,255,0.3)}
.ps-textarea::placeholder{color:#475569}
@media(max-width:768px){.ps-textarea{min-height:240px;font-size:13px}}

/* Review actions */
.ps-review-bar{display:flex;gap:8px;flex-wrap:wrap}
.ps-review-btn{padding:10px 18px;border-radius:10px;border:1px solid rgba(255,255,255,0.08);background:#0F1629;color:#94A3B8;font-family:'Sora',sans-serif;font-size:12px;font-weight:500;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;gap:6px}
.ps-review-btn:hover{border-color:rgba(0,212,255,0.25);color:#F0F2F5;background:rgba(0,212,255,0.04)}
.ps-review-btn:disabled{opacity:0.4;cursor:not-allowed}
@media(max-width:768px){.ps-review-btn{padding:8px 14px;font-size:11px}}

/* Refine chat input */
.ps-refine{display:flex;gap:10px;margin-top:8px}
.ps-refine input{flex:1;padding:12px 16px;border-radius:10px;background:#0F1629;border:1.5px solid rgba(255,255,255,0.08);color:#F0F2F5;font-family:'Sora',sans-serif;font-size:13px;outline:none;transition:border-color 0.2s}
.ps-refine input:focus{border-color:#00D4FF}
.ps-refine input::placeholder{color:#475569}
.ps-refine button{padding:12px 20px;border-radius:10px;border:none;background:linear-gradient(135deg,#00D4FF,#0096B4);color:#fff;font-family:'Sora',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.2s;white-space:nowrap}
.ps-refine button:disabled{opacity:0.4;cursor:not-allowed}

/* AI feedback box */
.ps-feedback{padding:16px 20px;border-radius:12px;background:rgba(0,212,255,0.04);border:1px solid rgba(0,212,255,0.12);margin-top:8px;animation:fadeUp 0.3s ease}
.ps-feedback-head{font-size:11px;font-weight:700;color:#00D4FF;text-transform:uppercase;letter-spacing:0.8px;margin-bottom:8px;display:flex;align-items:center;gap:6px}
.ps-feedback-text{font-size:13px;color:#CBD5E1;line-height:1.7}

/* Generating spinner */
.ps-generating{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:80px 20px;gap:20px}
.ps-generating-spin{width:40px;height:40px;border:3px solid rgba(0,212,255,0.15);border-top-color:#00D4FF;border-radius:50%;animation:spin 0.8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.ps-generating-text{font-size:16px;color:#94A3B8;text-align:center}
.ps-generating-sub{font-size:13px;color:#64748B;text-align:center}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useRef, useEffect } = React;

const API_ENDPOINT = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') ? null : '/.netlify/functions/chat';

const PROGRAMMES = [
  {id:"P001",uni:"University of Manchester",name:"BSc Business Management",subject:"Business",duration:3,foundation:false,fee:28500,city:"Manchester",region:"North West",qsRank:32,ielts:6.5,aLevel:"AAB",empRate:92,highSkill:71,salary:26000,satisfaction:82,continuation:94,intlPct:42,accreditations:"AACSB, EQUIS, AMBA",scholarship:"Global Futures: £5,000/yr",scholarshipVal:5000,livingCost:12000},
  {id:"P002",uni:"University of Manchester",name:"BSc Computer Science",subject:"Computing",duration:3,foundation:false,fee:30000,city:"Manchester",region:"North West",qsRank:32,ielts:6.5,aLevel:"A*AA",empRate:95,highSkill:78,salary:30000,satisfaction:80,continuation:95,intlPct:38,accreditations:"BCS",scholarship:"Dept scholarship: £3,000",scholarshipVal:3000,livingCost:12000},
  {id:"P003",uni:"University of Leeds",name:"BA Business Management",subject:"Business",duration:3,foundation:false,fee:27250,city:"Leeds",region:"Yorkshire",qsRank:75,ielts:6.5,aLevel:"AAB",empRate:90,highSkill:68,salary:25000,satisfaction:84,continuation:93,intlPct:35,accreditations:"AACSB, EQUIS, AMBA",scholarship:"Excellence: £5,000",scholarshipVal:5000,livingCost:10500},
  {id:"P004",uni:"University of Leeds",name:"BSc Computer Science",subject:"Computing",duration:3,foundation:false,fee:28750,city:"Leeds",region:"Yorkshire",qsRank:75,ielts:6.5,aLevel:"AAA",empRate:93,highSkill:75,salary:28500,satisfaction:81,continuation:94,intlPct:30,accreditations:"BCS",scholarship:"Faculty: £3,000",scholarshipVal:3000,livingCost:10500},
  {id:"P005",uni:"University of Exeter",name:"BSc Business and Management",subject:"Business",duration:3,foundation:false,fee:23700,city:"Exeter",region:"South West",qsRank:153,ielts:6.5,aLevel:"AAB",empRate:89,highSkill:67,salary:25500,satisfaction:86,continuation:95,intlPct:30,accreditations:"AACSB, EQUIS",scholarship:"Global Excellence: up to £10,000",scholarshipVal:10000,livingCost:10000},
  {id:"P006",uni:"University of Exeter",name:"BSc Computer Science",subject:"Computing",duration:3,foundation:false,fee:28500,city:"Exeter",region:"South West",qsRank:153,ielts:6.5,aLevel:"AAA",empRate:92,highSkill:74,salary:28000,satisfaction:83,continuation:94,intlPct:25,accreditations:"BCS",scholarship:null,scholarshipVal:0,livingCost:10000},
  {id:"P007",uni:"University of Sussex",name:"BSc Business and Management Studies",subject:"Business",duration:3,foundation:false,fee:20000,city:"Brighton",region:"South East",qsRank:218,ielts:6.5,aLevel:"ABB",empRate:87,highSkill:62,salary:24000,satisfaction:79,continuation:90,intlPct:40,accreditations:null,scholarship:"Chancellor's Intl: £5,000",scholarshipVal:5000,livingCost:11000},
  {id:"P008",uni:"University of Sussex",name:"BSc Computer Science",subject:"Computing",duration:3,foundation:false,fee:22500,city:"Brighton",region:"South East",qsRank:218,ielts:6.5,aLevel:"ABB",empRate:91,highSkill:72,salary:27000,satisfaction:78,continuation:91,intlPct:35,accreditations:"BCS",scholarship:"Chancellor's Intl: £5,000",scholarshipVal:5000,livingCost:11000},
  {id:"P009",uni:"University of Glasgow",name:"BAcc/MA Business & Management",subject:"Business",duration:4,foundation:false,fee:25750,city:"Glasgow",region:"Scotland",qsRank:78,ielts:6.5,aLevel:"AAB-ABB",empRate:91,highSkill:70,salary:25000,satisfaction:85,continuation:93,intlPct:32,accreditations:"AACSB, EQUIS, AMBA",scholarship:"Excellence Award: £5,000",scholarshipVal:5000,livingCost:10000},
  {id:"P010",uni:"University of Glasgow",name:"BSc Computing Science",subject:"Computing",duration:4,foundation:false,fee:28420,city:"Glasgow",region:"Scotland",qsRank:78,ielts:6.5,aLevel:"AAB",empRate:94,highSkill:77,salary:29000,satisfaction:82,continuation:94,intlPct:28,accreditations:"BCS",scholarship:"Excellence Award: £5,000",scholarshipVal:5000,livingCost:10000},
  {id:"P011",uni:"Coventry University",name:"BA Business Management",subject:"Business",duration:3,foundation:false,fee:16800,city:"Coventry",region:"West Midlands",qsRank:571,ielts:6.0,aLevel:"BCC-BBC",empRate:85,highSkill:55,salary:22000,satisfaction:80,continuation:88,intlPct:48,accreditations:"CMI",scholarship:"Up to £2,000",scholarshipVal:2000,livingCost:9500},
  {id:"P012",uni:"Coventry University",name:"BSc Computer Science",subject:"Computing",duration:3,foundation:false,fee:18600,city:"Coventry",region:"West Midlands",qsRank:571,ielts:6.0,aLevel:"BCC-BBC",empRate:88,highSkill:65,salary:25000,satisfaction:77,continuation:87,intlPct:42,accreditations:"BCS",scholarship:"Up to £2,000",scholarshipVal:2000,livingCost:9500},
  {id:"P013",uni:"University of Nottingham",name:"BSc Business Management",subject:"Business",duration:3,foundation:false,fee:23760,city:"Nottingham",region:"East Midlands",qsRank:100,ielts:6.5,aLevel:"AAB",empRate:90,highSkill:69,salary:25500,satisfaction:83,continuation:94,intlPct:38,accreditations:"AACSB, EQUIS",scholarship:"Developing Solutions: up to 100% fees",scholarshipVal:23760,livingCost:10000},
  {id:"P014",uni:"University of Nottingham",name:"BSc Computer Science",subject:"Computing",duration:3,foundation:false,fee:28600,city:"Nottingham",region:"East Midlands",qsRank:100,ielts:6.5,aLevel:"A*AA",empRate:94,highSkill:76,salary:29500,satisfaction:81,continuation:95,intlPct:32,accreditations:"BCS",scholarship:"Developing Solutions: up to 100% fees",scholarshipVal:28600,livingCost:10000},
  {id:"P015",uni:"University of Salford",name:"BSc Business Management",subject:"Business",duration:3,foundation:false,fee:15600,city:"Salford",region:"North West",qsRank:801,ielts:6.0,aLevel:"BCC-CCC",empRate:83,highSkill:50,salary:21500,satisfaction:76,continuation:85,intlPct:35,accreditations:null,scholarship:"VC Scholarship: £3,000",scholarshipVal:3000,livingCost:10500},
  {id:"P016",uni:"University of Salford",name:"BSc Computer Science",subject:"Computing",duration:3,foundation:false,fee:16500,city:"Salford",region:"North West",qsRank:801,ielts:6.0,aLevel:"BCC-CCC",empRate:86,highSkill:62,salary:24000,satisfaction:74,continuation:84,intlPct:30,accreditations:"BCS",scholarship:"VC Scholarship: £3,000",scholarshipVal:3000,livingCost:10500},
  {id:"P017",uni:"Newcastle University",name:"BSc Business Management",subject:"Business",duration:3,foundation:false,fee:24300,city:"Newcastle",region:"North East",qsRank:110,ielts:6.5,aLevel:"AAB",empRate:91,highSkill:68,salary:25000,satisfaction:85,continuation:94,intlPct:30,accreditations:"AACSB, EQUIS, AMBA",scholarship:"Intl Scholarship: £3,000",scholarshipVal:3000,livingCost:9500},
  {id:"P018",uni:"Newcastle University",name:"BSc Computer Science",subject:"Computing",duration:3,foundation:false,fee:28400,city:"Newcastle",region:"North East",qsRank:110,ielts:6.5,aLevel:"AAA",empRate:93,highSkill:75,salary:28500,satisfaction:82,continuation:95,intlPct:25,accreditations:"BCS",scholarship:"Intl Scholarship: £3,000",scholarshipVal:3000,livingCost:9500},
  {id:"P019",uni:"De Montfort University",name:"BA Business Management",subject:"Business",duration:3,foundation:false,fee:15750,city:"Leicester",region:"East Midlands",qsRank:801,ielts:6.0,aLevel:"BCC-CCC",empRate:84,highSkill:52,salary:21000,satisfaction:78,continuation:86,intlPct:45,accreditations:"CMI",scholarship:"VC Scholarship: £2,500",scholarshipVal:2500,livingCost:9000},
  {id:"P020",uni:"De Montfort University",name:"BSc Computer Science",subject:"Computing",duration:3,foundation:false,fee:15750,city:"Leicester",region:"East Midlands",qsRank:801,ielts:6.0,aLevel:"BCC-CCC",empRate:87,highSkill:63,salary:24000,satisfaction:75,continuation:85,intlPct:40,accreditations:"BCS",scholarship:"VC Scholarship: £2,500",scholarshipVal:2500,livingCost:9000},
  {id:"P021",uni:"University of Manchester",name:"BSc Business Management with Foundation Year",subject:"Business",duration:4,foundation:true,fee:22000,city:"Manchester",region:"North West",qsRank:32,ielts:5.5,aLevel:"CCC-CCD",empRate:92,highSkill:71,salary:26000,satisfaction:82,continuation:91,intlPct:55,accreditations:"AACSB, EQUIS, AMBA",scholarship:"Foundation bursary: £2,000",scholarshipVal:2000,livingCost:12000},
  {id:"P022",uni:"University of Sussex",name:"BSc Computer Science with Foundation Year",subject:"Computing",duration:4,foundation:true,fee:18000,city:"Brighton",region:"South East",qsRank:218,ielts:5.5,aLevel:"CCC-CCD",empRate:91,highSkill:72,salary:27000,satisfaction:78,continuation:88,intlPct:45,accreditations:"BCS",scholarship:"Chancellor's Intl: £5,000",scholarshipVal:5000,livingCost:11000},
  {id:"P023",uni:"Coventry University",name:"BA Business Management with Foundation Year",subject:"Business",duration:4,foundation:true,fee:16800,city:"Coventry",region:"West Midlands",qsRank:571,ielts:5.5,aLevel:"CDD-DDD",empRate:85,highSkill:55,salary:22000,satisfaction:80,continuation:85,intlPct:55,accreditations:"CMI",scholarship:"Up to £2,000",scholarshipVal:2000,livingCost:9500},
  {id:"P024",uni:"University of Nottingham",name:"BSc Computer Science with Foundation Year",subject:"Computing",duration:4,foundation:true,fee:22000,city:"Nottingham",region:"East Midlands",qsRank:100,ielts:5.5,aLevel:"BCC-CCC",empRate:94,highSkill:76,salary:29500,satisfaction:81,continuation:92,intlPct:45,accreditations:"BCS",scholarship:"Developing Solutions: up to 100% fees",scholarshipVal:22000,livingCost:10000},
  {id:"P025",uni:"De Montfort University",name:"BSc Computer Science with Foundation Year",subject:"Computing",duration:4,foundation:true,fee:15750,city:"Leicester",region:"East Midlands",qsRank:801,ielts:5.5,aLevel:"DDD-DD",empRate:87,highSkill:63,salary:24000,satisfaction:75,continuation:82,intlPct:50,accreditations:"BCS",scholarship:"VC Scholarship: £2,500",scholarshipVal:2500,livingCost:9000},
  {id:"P026",uni:"University of Birmingham",name:"BSc Business Management",subject:"Business",duration:3,foundation:false,fee:24120,city:"Birmingham",region:"West Midlands",qsRank:80,ielts:6.5,aLevel:"AAA-AAB",empRate:91,highSkill:70,salary:26000,satisfaction:84,continuation:95,intlPct:35,accreditations:"AACSB, EQUIS, AMBA",scholarship:"Birmingham Scholarship: £2,000",scholarshipVal:2000,livingCost:10500},
  {id:"P027",uni:"University of Birmingham",name:"BSc Computer Science",subject:"Computing",duration:3,foundation:false,fee:28800,city:"Birmingham",region:"West Midlands",qsRank:80,ielts:6.5,aLevel:"A*AA",empRate:94,highSkill:77,salary:29500,satisfaction:82,continuation:96,intlPct:30,accreditations:"BCS",scholarship:"Birmingham Scholarship: £2,000",scholarshipVal:2000,livingCost:10500},
  {id:"P028",uni:"University of Sheffield",name:"BSc Business Management",subject:"Business",duration:3,foundation:false,fee:23250,city:"Sheffield",region:"Yorkshire",qsRank:105,ielts:6.5,aLevel:"AAB",empRate:90,highSkill:67,salary:25000,satisfaction:83,continuation:93,intlPct:33,accreditations:"AACSB, EQUIS, AMBA",scholarship:"Intl Merit: 25-50% of fees",scholarshipVal:11625,livingCost:9500},
  {id:"P029",uni:"University of Sheffield",name:"BSc Computer Science",subject:"Computing",duration:3,foundation:false,fee:28500,city:"Sheffield",region:"Yorkshire",qsRank:105,ielts:6.5,aLevel:"AAA",empRate:93,highSkill:76,salary:29000,satisfaction:80,continuation:94,intlPct:28,accreditations:"BCS",scholarship:"Intl Merit: 25-50% of fees",scholarshipVal:14250,livingCost:9500},
  {id:"P030",uni:"University of Salford",name:"BSc Business Management with Foundation Year",subject:"Business",duration:4,foundation:true,fee:15600,city:"Salford",region:"North West",qsRank:801,ielts:5.5,aLevel:"DDD-DD",empRate:83,highSkill:50,salary:21500,satisfaction:76,continuation:82,intlPct:42,accreditations:null,scholarship:"VC Scholarship: £3,000",scholarshipVal:3000,livingCost:10500}
];

const COUNTRIES_DATA = {"Nigeria":{quals:"WAEC/NECO O-Levels, UTME",ieltsRange:"5.0-6.5",budgetSens:"High",englishLevel:"Moderate",flightCost:650,visaCost:363,ihsCost:776,communityFactor:"Strong Nigerian student communities at Coventry, DMU, Manchester, Nottingham"},"India":{quals:"CBSE/ISC Class 12",ieltsRange:"5.5-7.0",budgetSens:"High",englishLevel:"Moderate-High",flightCost:550,visaCost:363,ihsCost:776,communityFactor:"Large Indian student populations at Birmingham, Manchester, Sheffield, Glasgow"},"China":{quals:"Gaokao, A-Levels",ieltsRange:"5.0-6.5",budgetSens:"Moderate",englishLevel:"Low-Moderate",flightCost:750,visaCost:363,ihsCost:776,communityFactor:"Established Chinese communities at Manchester, Glasgow, Birmingham, Nottingham"},"Pakistan":{quals:"HSC/Intermediate, A-Levels",ieltsRange:"5.0-6.5",budgetSens:"High",englishLevel:"Moderate",flightCost:500,visaCost:363,ihsCost:776,communityFactor:"Strong Pakistani communities at Manchester, Leeds, Coventry"},"Bangladesh":{quals:"HSC, A-Levels",ieltsRange:"5.0-6.0",budgetSens:"Very High",englishLevel:"Low-Moderate",flightCost:600,visaCost:363,ihsCost:776,communityFactor:"Growing communities at Coventry, DMU Leicester, Salford"},"Ghana":{quals:"WASSCE, A-Levels",ieltsRange:"5.0-6.5",budgetSens:"High",englishLevel:"Moderate",flightCost:600,visaCost:363,ihsCost:776,communityFactor:"Active Ghanaian societies at many UK universities"},"Saudi Arabia":{quals:"Tawjihi",ieltsRange:"5.0-6.0",budgetSens:"Low (if gov sponsored)",englishLevel:"Low",flightCost:450,visaCost:363,ihsCost:776,communityFactor:"Islamic societies and prayer facilities at most UK universities"},"Vietnam":{quals:"High School Diploma",ieltsRange:"5.0-6.0",budgetSens:"High",englishLevel:"Low",flightCost:700,visaCost:363,ihsCost:776,communityFactor:"Growing Vietnamese communities at Manchester, Leeds, Glasgow"},"Kenya":{quals:"KCSE Certificate",ieltsRange:"5.5-6.5",budgetSens:"High",englishLevel:"Moderate-High",flightCost:550,visaCost:363,ihsCost:776,communityFactor:"Kenyan student networks at Nottingham, Manchester, Leeds, Newcastle"},"Turkey":{quals:"Lise Diplomasi",ieltsRange:"5.0-6.5",budgetSens:"Moderate",englishLevel:"Moderate",flightCost:250,visaCost:363,ihsCost:776,communityFactor:"Turkish societies at many Russell Group universities"}};

const OUTCOME_SIMS = {"Nigeria":{high:{empRate:88,salary:24500,highSkill:65,note:"Nigerian graduates from top-50 UK unis report strong outcomes in finance and consulting"},mid:{empRate:84,salary:22000,highSkill:58,note:"Many Nigerian graduates from mid-ranked UK unis enter management and operations roles"},accessible:{empRate:80,salary:20000,highSkill:48,note:"Nigerian graduates from accessible unis often pursue further study or enter SME management"}},"India":{high:{empRate:91,salary:28000,highSkill:72,note:"Indian graduates from top-50 UK unis are highly sought after in tech and financial services"},mid:{empRate:87,salary:25000,highSkill:64,note:"Indian graduates from mid-ranked UK unis report strong outcomes in IT and business analytics"},accessible:{empRate:83,salary:22000,highSkill:55,note:"Indian graduates from accessible unis often find roles in IT support, operations, and consulting"}},"China":{high:{empRate:85,salary:26000,highSkill:68,note:"Chinese graduates from top-50 UK unis often return to China with strong salary premiums"},mid:{empRate:81,salary:23000,highSkill:60,note:"Chinese graduates from mid-ranked UK unis report good outcomes in finance and marketing"},accessible:{empRate:77,salary:20500,highSkill:50,note:"Chinese graduates from accessible unis often leverage UK degree for roles at multinationals in China"}},"Pakistan":{high:{empRate:87,salary:24000,highSkill:63,note:"Pakistani graduates from top-50 UK unis find opportunities in banking, consulting and tech"},mid:{empRate:83,salary:21500,highSkill:56,note:"Pakistani graduates from mid-ranked UK unis often enter business management and IT roles"},accessible:{empRate:79,salary:19500,highSkill:47,note:"Pakistani graduates from accessible unis pursue roles in administration, marketing, and IT support"}}};
const DEFAULT_OUTCOME = {high:{empRate:87,salary:25000,highSkill:66,note:"International graduates from top UK universities report strong employment outcomes"},mid:{empRate:83,salary:22500,highSkill:58,note:"International graduates from mid-ranked universities enter diverse professional roles"},accessible:{empRate:79,salary:20000,highSkill:49,note:"International graduates from accessible universities benefit from UK work experience via Graduate Route"}};

function getOutcome(c, r) { const d = OUTCOME_SIMS[c] || DEFAULT_OUTCOME; if (r <= 120) return d.high; if (r <= 400) return d.mid; return d.accessible; }
function getTotalCost(p, c) { const cd = COUNTRIES_DATA[c]; const fl = cd ? cd.flightCost : 600; const ihs = cd ? cd.ihsCost : 776; const visa = cd ? cd.visaCost : 363; const sv = p.scholarshipVal || 0; const totalBefore = (p.fee * p.duration) + (p.livingCost * p.duration) + visa + (ihs * p.duration) + fl; const totalAfterSchol = totalBefore - (sv * p.duration); return { annual: p.fee + p.livingCost, total: totalBefore, totalAfterSchol, flight: fl, visa, ihs, scholTotal: sv * p.duration }; }
function getElig(p, s) { const i = parseFloat(s); if (isNaN(i)) return { st:"unk", label:"IELTS needed", cls:"elig-unk" }; if (i >= p.ielts) return { st:"ok", label:"Direct entry", cls:"elig-direct" }; if (i >= p.ielts - 0.5) return { st:"cond", label:"Conditional — may need pre-sessional English", cls:"elig-cond" }; return { st:"low", label:"Below requirement — foundation year or IELTS retake needed", cls:"elig-below" }; }

const COUNTRY_LIST = ["Nigeria","India","China","Pakistan","Bangladesh","Ghana","Saudi Arabia","Vietnam","Kenya","Turkey","Brazil","Indonesia","Thailand","Malaysia","Sri Lanka","Nepal","Egypt","Iran","Colombia","Mexico","Philippines","South Korea","Japan","Taiwan","Hong Kong","UAE","Kuwait","Oman","Qatar","Jordan","Other"];

function buildSys(p) {
  const cd = COUNTRIES_DATA[p.country];
  const progs = PROGRAMMES.map(x => ({id:x.id,uni:x.uni,name:x.name,subject:x.subject,fee:x.fee,city:x.city,qsRank:x.qsRank,ielts:x.ielts,aLevel:x.aLevel,empRate:x.empRate,highSkill:x.highSkill,salary:x.salary,satisfaction:x.satisfaction,foundation:x.foundation,duration:x.duration,scholarship:x.scholarship,scholarshipVal:x.scholarshipVal,livingCost:x.livingCost}));
  const engStr = p.englishType === 'ielts' ? 'IELTS ' + p.englishScore : p.englishType === 'toefl' ? 'TOEFL ' + p.englishScore : p.englishType === 'native' ? 'Native speaker' : p.ielts || "Not yet taken";
  const priStr = Array.isArray(p.priorities) ? p.priorities.join(', ') : (p.priorities || '');
  return "You are PathfinderAI, an expert university advisor helping international students find the right UK undergraduate programme. You work for the STUDENT, not the universities. You are warm, honest, and genuinely invested.\n\nSTUDENT PROFILE:\n- Country: " + p.country + "\n- Subject: " + p.subject + "\n- Qualifications: " + p.qualifications + "\n- English: " + engStr + "\n- Budget: " + p.budget + "\n- Priorities: " + priStr + (p.career ? "\n- Career goal: " + p.career : "") + (p.living ? "\n- Living preference: " + p.living : "") + (p.timeline ? "\n- Start: " + p.timeline : "") + (cd ? "\n\nCOUNTRY CONTEXT:\n- Typical quals: " + cd.quals + "\n- IELTS range: " + cd.ieltsRange + "\n- Budget sensitivity: " + cd.budgetSens + "\n- Community: " + cd.communityFactor + "\n- Flight: £" + cd.flightCost + ", Visa: £" + cd.visaCost + ", IHS/yr: £" + cd.ihsCost : "") + "\n\nPROGRAMME DATABASE:\n" + JSON.stringify(progs) + "\n\nRULES:\n1. Start by acknowledging the student and asking 1-2 clarifying questions. Do NOT recommend in your first message.\n2. When ready, include: |||PROGRAMMES|||[\"P001\",\"P013\"]|||END|||\n3. Be OUTCOME-LED. Reference employment rates, salaries, what students from their country experience.\n4. Be HONEST about trade-offs.\n5. Consider TOTAL COST: fees + living + visa + IHS + flights - scholarship.\n6. Suggest foundation year if IELTS/quals are below direct entry.\n7. Reference country context and community.\n8. Mention the 2-year Graduate Route visa.\n9. Keep under 300 words. Be conversational.\n10. Never recommend based on university payments. You work for the student.";
}

function parseMsg(text) {
  const m = text.match(/\|\|\|PROGRAMMES\|\|\|(.*?)\|\|\|END\|\|\|/s);
  let progs = []; let clean = text;
  if (m) { try { progs = JSON.parse(m[1]); } catch(e) {} clean = text.replace(/\|\|\|PROGRAMMES\|\|\|.*?\|\|\|END\|\|\|/s, '').trim(); }
  return { text: clean, programmes: progs };
}

function ProgrammeCard({ progId, country, ielts }) {
  const [tab, setTab] = useState('outcomes');
  const p = PROGRAMMES.find(x => x.id === progId);
  if (!p) return null;
  const el = getElig(p, ielts);
  const oc = getOutcome(country, p.qsRank);
  const tc = getTotalCost(p, country);
  const tier = p.qsRank <= 120 ? 'top-tier' : p.qsRank <= 400 ? 'mid-ranked' : 'accessible';
  const sv = p.scholarshipVal || 0;

  return (
    <div className="pcard">
      <div className="pc-top">
        <div className="pc-header">
          <span className="pc-uni">{p.uni}</span>
          <span className="pc-rank">QS #{p.qsRank}</span>
        </div>
        <div className="pc-name">{p.name}</div>
        <div className="pc-tags">
          <span className="pc-tag t-fee">{"£" + p.fee.toLocaleString() + "/yr"}</span>
          <span className="pc-tag t-city">{p.city}</span>
          <span className="pc-tag t-dur">{p.duration + " yrs"}</span>
          {p.foundation && <span className="pc-tag t-fnd">Foundation Year</span>}
        </div>
      </div>
      <div className={"pc-elig " + el.cls}>
        <span>{el.st === 'ok' ? '✓' : el.st === 'cond' ? '⚠' : el.st === 'low' ? '✗' : '?'}</span>
        {" " + el.label}
      </div>
      <div className="pc-tabs">
        <button className={"pc-tab" + (tab === 'outcomes' ? ' on' : '')} onClick={() => setTab('outcomes')}>Outcomes</button>
        <button className={"pc-tab" + (tab === 'students' ? ' on' : '')} onClick={() => setTab('students')}>Students Like Me</button>
        <button className={"pc-tab" + (tab === 'cost' ? ' on' : '')} onClick={() => setTab('cost')}>Total Cost</button>
      </div>
      <div className="pc-panel">
        {tab === 'outcomes' && (
          <div className="pc-stats">
            <div className="ps"><div className="ps-v">{p.empRate + "%"}</div><div className="ps-l">Employed</div></div>
            <div className="ps"><div className="ps-v">{p.highSkill + "%"}</div><div className="ps-l">Graduate jobs</div></div>
            <div className="ps"><div className="ps-v">{"£" + (p.salary/1000).toFixed(0) + "k"}</div><div className="ps-l">Median salary</div></div>
            <div className="ps"><div className="ps-v">{p.satisfaction + "%"}</div><div className="ps-l">Satisfaction</div></div>
          </div>
        )}
        {tab === 'students' && (
          <div className="slm-box">
            <div className="slm-title"><span>👤</span>{" " + (country || 'International') + " graduates from " + tier + " UK universities"}</div>
            <div className="slm-stats">
              <div className="slm-stat"><div className="slm-v">{oc.empRate + "%"}</div><div className="slm-l">Employed</div></div>
              <div className="slm-stat"><div className="slm-v">{"£" + (oc.salary/1000).toFixed(1) + "k"}</div><div className="slm-l">Avg salary</div></div>
              <div className="slm-stat"><div className="slm-v">{oc.highSkill + "%"}</div><div className="slm-l">Grad-level jobs</div></div>
            </div>
            <div className="slm-note">{oc.note}</div>
          </div>
        )}
        {tab === 'cost' && (
          <div className="tc-box">
            <div className="tc-title"><span>💰</span>{" Total cost of attendance (" + p.duration + " years)"}</div>
            <div className="tc-rows">
              <div className="tc-row"><span>{"Tuition (" + p.duration + " yrs)"}</span><span>{"£" + (p.fee * p.duration).toLocaleString()}</span></div>
              <div className="tc-row"><span>{"Living costs (" + p.duration + " yrs)"}</span><span>{"£" + (p.livingCost * p.duration).toLocaleString()}</span></div>
              <div className="tc-row sub"><span>Visa</span><span>{"£" + tc.visa}</span></div>
              <div className="tc-row sub"><span>{"IHS (" + p.duration + " yrs)"}</span><span>{"£" + (tc.ihs * p.duration).toLocaleString()}</span></div>
              <div className="tc-row sub"><span>Est. flights</span><span>{"£" + tc.flight}</span></div>
              <div className="tc-divider"></div>
              <div className="tc-row tc-total"><span>Total estimated cost</span><span>{"£" + tc.total.toLocaleString()}</span></div>
              {sv > 0 && <div className="tc-row" style={{color:'#059669'}}><span>{"Potential scholarship (" + p.duration + " yrs)"}</span><span>{"-£" + tc.scholTotal.toLocaleString()}</span></div>}
              {sv > 0 && <div className="tc-divider"></div>}
              {sv > 0 && <div className="tc-row tc-total"><span>Total if scholarship awarded</span><span>{"£" + tc.totalAfterSchol.toLocaleString()}</span></div>}
            </div>
            {p.scholarship && <div className="tc-schol"><span>🎓</span>{" " + p.scholarship}</div>}
          </div>
        )}
      </div>
    </div>
  );
}

// Homepage data — country/subject stats for Act 2
const HP_STATS = {
  "Nigeria": { "Business": { emp: 84, salary: "£22,000", premium: "2.8x", grad: 58 }, "Computer Science": { emp: 87, salary: "£25,000", premium: "3.2x", grad: 64 } },
  "India": { "Business": { emp: 87, salary: "£25,000", premium: "3.5x", grad: 64 }, "Computer Science": { emp: 91, salary: "£28,000", premium: "3.1x", grad: 72 } },
  "China": { "Business": { emp: 81, salary: "£23,000", premium: "2.2x", grad: 60 }, "Computer Science": { emp: 85, salary: "£26,000", premium: "2.5x", grad: 68 } },
  "Pakistan": { "Business": { emp: 83, salary: "£21,500", premium: "3.8x", grad: 56 }, "Computer Science": { emp: 87, salary: "£24,000", premium: "4.2x", grad: 63 } },
  "Bangladesh": { "Business": { emp: 80, salary: "£20,000", premium: "4.5x", grad: 50 }, "Computer Science": { emp: 84, salary: "£23,000", premium: "5.1x", grad: 58 } },
  "Ghana": { "Business": { emp: 82, salary: "£21,000", premium: "3.0x", grad: 54 }, "Computer Science": { emp: 86, salary: "£24,000", premium: "3.4x", grad: 62 } },
  "Kenya": { "Business": { emp: 83, salary: "£22,000", premium: "3.2x", grad: 57 }, "Computer Science": { emp: 87, salary: "£25,000", premium: "3.6x", grad: 64 } },
  "Saudi Arabia": { "Business": { emp: 79, salary: "£22,000", premium: "1.4x", grad: 52 }, "Computer Science": { emp: 83, salary: "£25,000", premium: "1.6x", grad: 60 } },
  "Vietnam": { "Business": { emp: 81, salary: "£21,000", premium: "4.8x", grad: 53 }, "Computer Science": { emp: 85, salary: "£24,000", premium: "5.5x", grad: 61 } },
  "Turkey": { "Business": { emp: 82, salary: "£22,000", premium: "2.6x", grad: 55 }, "Computer Science": { emp: 86, salary: "£25,000", premium: "2.9x", grad: 63 } },
};
const HP_DEFAULT = { "Business": { emp: 83, salary: "£22,000", premium: "3.0x", grad: 58 }, "Computer Science": { emp: 87, salary: "£25,000", premium: "3.2x", grad: 66 } };
const HP_COUNTRIES = ["Nigeria","India","China","Pakistan","Bangladesh","Ghana","Saudi Arabia","Vietnam","Kenya","Turkey"];

// Scroll animation hook
function useScrollAnim() {
  const ref = useRef(null);
  useEffect(() => {
    const el = ref.current;
    if (!el) return;
    const obs = new IntersectionObserver(([entry]) => {
      if (entry.isIntersecting) { el.classList.add('hp-visible'); obs.unobserve(el); }
    }, { threshold: 0.15 });
    obs.observe(el);
    return () => obs.disconnect();
  }, []);
  return ref;
}

function ScrollAnim({ children, className, delay }) {
  const ref = useScrollAnim();
  return <div ref={ref} className={"hp-anim" + (delay ? " hp-anim-delay-" + delay : "") + (className ? " " + className : "")}>{children}</div>;
}

function ValueMap({ country, subject }) {
  const vmRef = useRef(null);
  const [visible, setVisible] = useState(false);
  useEffect(() => {
    const el = vmRef.current;
    if (!el) return;
    const obs = new IntersectionObserver(([entry]) => {
      if (entry.isIntersecting) { setVisible(true); obs.unobserve(el); }
    }, { threshold: 0.15 });
    obs.observe(el);
    return () => obs.disconnect();
  }, []);

  const ready = country && subject;

  // ROI tier: total cost / salary — lower = better
  function roiTier(ratio) {
    if (ratio < 3) return { tier: 'strong', label: 'Strong ROI' };
    if (ratio < 4) return { tier: 'good', label: 'Good ROI' };
    if (ratio < 5) return { tier: 'avg', label: 'Average ROI' };
    return { tier: 'poor', label: 'Poor ROI' };
  }

  // Build bubble data only when both selected
  let positioned = [];
  if (ready) {
    const progSubject = subject === 'Computer Science' ? 'Computing' : subject;
    const filtered = PROGRAMMES.filter(p => p.subject === progSubject && !p.foundation);
    const shortName = (n) => n.replace('University of ','').replace(' University','').replace('De Montfort','DMU');

    const bubbles = filtered.map(p => {
      const tc = getTotalCost(p, country);
      const costK = Math.round(tc.total / 1000);
      const salK = p.salary / 1000;
      const ratio = tc.total / p.salary;
      const rt = roiTier(ratio);
      return { id: p.id, uni: shortName(p.uni), progName: p.name, totalCost: tc.total, costK, salary: p.salary, salK, empRate: p.empRate, ratio, tier: rt.tier, roiLabel: rt.label, duration: p.duration };
    });

    const costs = bubbles.map(b => b.totalCost);
    const salaries = bubbles.map(b => b.salary);
    const minCost = Math.min(...costs), maxCost = Math.max(...costs);
    const minSal = Math.min(...salaries), maxSal = Math.max(...salaries);
    const costRange = maxCost - minCost || 1;
    const salRange = maxSal - minSal || 1;

    positioned = bubbles.map(b => {
      const xPct = 12 + ((b.totalCost - minCost) / costRange) * 70;
      const yPct = 10 + ((maxSal - b.salary) / salRange) * 62;
      return { ...b, xPct, yPct };
    });

    // Collision detection — nudge overlapping bubbles
    const bw = 14, bh = 9;
    for (let pass = 0; pass < 5; pass++) {
      for (let i = 0; i < positioned.length; i++) {
        for (let j = i + 1; j < positioned.length; j++) {
          const a = positioned[i], b = positioned[j];
          const dx = Math.abs(a.xPct - b.xPct), dy = Math.abs(a.yPct - b.yPct);
          if (dx < bw && dy < bh) {
            const nudge = (bh - dy) / 2 + 1.5;
            if (a.yPct <= b.yPct) { a.yPct -= nudge; b.yPct += nudge; }
            else { a.yPct += nudge; b.yPct -= nudge; }
            a.yPct = Math.max(4, Math.min(78, a.yPct));
            b.yPct = Math.max(4, Math.min(78, b.yPct));
          }
        }
      }
    }
  }

  return (
    <div className="hp-vmap" ref={vmRef}>
      {ready ? (
        <>
          <div className="hp-vmap-label tl">✦ Best value</div>
          <div className="hp-vmap-label br">Worst value ✦</div>
          <div className="hp-vmap-zone"></div>
          <div className="hp-vmap-axis"></div>
          <div className="hp-vmap-axis-x">Total cost →</div>
          <div className="hp-vmap-axis-y">Graduate salary →</div>
          {positioned.map((b, i) => (
            <div key={b.id}
              className={"hp-vmap-bubble " + b.tier + (visible ? " hp-bv" : "")}
              style={{ top: b.yPct.toFixed(1) + '%', left: b.xPct.toFixed(1) + '%', transitionDelay: visible ? (i * 0.06) + 's' : '0s' }}>
              <div className="bname">{b.uni}</div>
              <div className="broi-tag">{b.roiLabel}</div>
              <div className="hp-vmap-tip">
                <div className="hp-vmap-tip-uni">{b.uni}</div>
                <div className="hp-vmap-tip-prog">{b.progName}</div>
                <div className="hp-vmap-tip-grid">
                  <div><div className="hp-vmap-tip-label">Total cost ({b.duration}yr)</div><div className="hp-vmap-tip-val">{'£' + b.costK.toLocaleString() + 'k'}</div></div>
                  <div><div className="hp-vmap-tip-label">Median salary</div><div className="hp-vmap-tip-val">{'£' + b.salK.toLocaleString() + 'k'}</div></div>
                  <div><div className="hp-vmap-tip-label">Employment</div><div className="hp-vmap-tip-val">{b.empRate + '%'}</div></div>
                  <div><div className="hp-vmap-tip-label">ROI ratio</div><div className="hp-vmap-tip-val">{b.ratio.toFixed(1) + 'x'}</div></div>
                </div>
                <div className="hp-vmap-tip-payback">{'Pays back in ~' + b.ratio.toFixed(1) + ' years at starting salary'}</div>
              </div>
            </div>
          ))}
        </>
      ) : (
        <div className="hp-vmap-empty">Select a country and subject to see the value map</div>
      )}
    </div>
  );
}

function Homepage({ onStart, profile, onNavigate }) {
  const hasProfile = !!(profile && profile.country);
  const [hpCountry, setHpCountry] = useState('');
  const [hpSubject, setHpSubject] = useState('');
  const [showNav, setShowNav] = useState(false);
  const act1Ref = useRef(null);

  const bothSelected = hpCountry && hpSubject;
  const d = bothSelected ? ((HP_STATS[hpCountry] || HP_DEFAULT)[hpSubject] || HP_DEFAULT[hpSubject]) : { emp: 85, salary: '£24,000', premium: '3.0x', grad: 60 };

  // Sticky nav on scroll
  useEffect(() => {
    const handler = () => {
      if (act1Ref.current) {
        setShowNav(window.scrollY > act1Ref.current.offsetHeight - 80);
      }
    };
    window.addEventListener('scroll', handler, { passive: true });
    return () => window.removeEventListener('scroll', handler);
  }, []);

  return (
    <div className="hp">
      {/* Sticky nav */}
      <div className={"hp-snav" + (showNav ? " hp-snav-show" : "")}>
        <div className="hp-snav-inner">
          <div className="hp-snav-logo">
            <div className="hp-snav-sq">P</div>
            <div className="hp-snav-t">Pathfinder<span className="hi">AI</span></div>
          </div>
          <div className="hp-snav-links">
            {hasProfile ? (<>
              <button className="hp-snav-link" onClick={() => onNavigate('dashboard')}>Dashboard</button>
              <button className="hp-snav-link" onClick={() => onNavigate('apply')}>Apply</button>
              <button className="hp-snav-link" onClick={() => onNavigate('chat')}>Chat</button>
              <div className="hp-snav-profile" onClick={() => onNavigate('dashboard')}>
                <span className="hp-snav-flag">{COUNTRY_EMOJIS[profile.country] || '🌍'}</span>
                <span className="hp-snav-name">{profile.country}</span>
              </div>
            </>) : (
              <button className="hp-snav-link" onClick={onStart}>Get started</button>
            )}
          </div>
        </div>
      </div>

      {/* Act 1: The Hook */}
      <div className="hp-act1" ref={act1Ref}>
        <h1 className="hp-hook">What could your life<br/>look like?</h1>
        <div className="hp-inline">
          <span>I'm from</span>
          <select className="hp-inline-sel" value={hpCountry} onChange={e => setHpCountry(e.target.value)}>
            <option value="" disabled>your country</option>
            {HP_COUNTRIES.map(c => <option key={c} value={c}>{c}</option>)}
          </select>
          <span>and I want to study</span>
          <select className="hp-inline-sel" value={hpSubject} onChange={e => setHpSubject(e.target.value)}>
            <option value="" disabled>a subject</option>
            <option value="Computer Science">Computer Science</option>
            <option value="Business">Business</option>
          </select>
        </div>
        <button className={"hp-go" + (bothSelected ? " hp-go-show" : "")} onClick={hasProfile ? () => onNavigate('dashboard') : onStart}>Show me &#8594;</button>
        <div className="hp-powered">Powered by data from 230,000 student journeys</div>
      </div>

      {/* Act 2: The Data Story */}
      <div className="hp-act2">
        <ScrollAnim>
          <div className="hp-act2-head">{bothSelected ? 'Students from ' + hpCountry + ' who studied ' + hpSubject + ' in the UK' : 'UK international graduates — average outcomes'}</div>
        </ScrollAnim>
        <div className="hp-stats">
          <ScrollAnim delay={1}>
            <div className="hp-stat">
              <div className="hp-stat-val teal">{d.emp}%</div>
              <div className="hp-stat-lab">found employment within 15 months</div>
            </div>
          </ScrollAnim>
          <ScrollAnim delay={2}>
            <div className="hp-stat">
              <div className="hp-stat-val green">{d.salary}</div>
              <div className="hp-stat-lab">median starting salary</div>
            </div>
          </ScrollAnim>
          <ScrollAnim delay={3}>
            <div className="hp-stat">
              <div className="hp-stat-val amber">{d.premium}</div>
              <div className="hp-stat-lab">salary premium vs home country average</div>
            </div>
          </ScrollAnim>
          <ScrollAnim delay={4}>
            <div className="hp-stat">
              <div className="hp-stat-val teal">{d.grad}%</div>
              <div className="hp-stat-lab">in graduate-level professional roles</div>
            </div>
          </ScrollAnim>
        </div>
        <ScrollAnim>
          <div className="hp-act2-note">Based on graduate outcome data across all UK university tiers. Your individual prediction depends on where you go.</div>
        </ScrollAnim>
      </div>

      {/* Act 3: The Stakes */}
      <div className="hp-act3">
        <ScrollAnim>
          <div className="hp-act3-head">But not all universities deliver<br/>the same outcome.</div>
        </ScrollAnim>
        <ScrollAnim>
          <div className="hp-act3-sel">
            <span>I'm from</span>
            <select value={hpCountry} onChange={e => setHpCountry(e.target.value)}>
              <option value="" disabled>your country</option>
              {HP_COUNTRIES.map(c => <option key={c} value={c}>{c}</option>)}
            </select>
            <span>and I want to study</span>
            <select value={hpSubject} onChange={e => setHpSubject(e.target.value)}>
              <option value="" disabled>a subject</option>
              <option value="Computer Science">Computer Science</option>
              <option value="Business">Business</option>
            </select>
          </div>
        </ScrollAnim>
        <ValueMap country={hpCountry} subject={hpSubject} />
        <div className="hp-vmap-note">Salary data reflects 15 months post-graduation (HESA Graduate Outcomes). Total cost includes tuition, living, visa, and health surcharge.</div>
        <ScrollAnim>
          <div className="hp-act3-big">The difference between the right choice and the wrong one? Up to £50,000 and a career.</div>
        </ScrollAnim>
        <ScrollAnim>
          <div className="hp-act3-sub">PathfinderAI shows you where the value is — before you commit.</div>
        </ScrollAnim>
      </div>

      {/* Act 4: The Platform */}
      <div className="hp-act4">
        <ScrollAnim>
          <div className="hp-act4-head">With you from first question to first job</div>
        </ScrollAnim>
        <ScrollAnim>
          <div className="hp-journey">
            <div className="hp-phase">
              <div className="hp-phase-dot"></div>
              <div className="hp-phase-line"></div>
              <div className="hp-phase-content">
                <div className="hp-phase-name">Dream</div>
                <div className="hp-phase-desc">See what's possible. Real outcomes from real students who started where you are.</div>
              </div>
            </div>
            <div className="hp-phase">
              <div className="hp-phase-dot"></div>
              <div className="hp-phase-line"></div>
              <div className="hp-phase-content">
                <div className="hp-phase-name">Plan</div>
                <div className="hp-phase-desc">AI-powered matching. Predicted outcomes, true costs, readiness scores.</div>
              </div>
            </div>
            <div className="hp-phase">
              <div className="hp-phase-dot"></div>
              <div className="hp-phase-line"></div>
              <div className="hp-phase-content">
                <div className="hp-phase-name">Prepare</div>
                <div className="hp-phase-desc">Application tracking, document prep, visa guidance, IELTS planning — one place for everything.</div>
              </div>
            </div>
            <div className="hp-phase dim">
              <div className="hp-phase-dot"></div>
              <div className="hp-phase-line"></div>
              <div className="hp-phase-content">
                <div className="hp-phase-name">Arrive</div>
                <div className="hp-phase-desc">City survival guides, student connections, first-week support.</div>
                <div className="hp-phase-badge">Coming soon</div>
              </div>
            </div>
            <div className="hp-phase dim">
              <div className="hp-phase-dot"></div>
              <div className="hp-phase-content">
                <div className="hp-phase-name">Thrive</div>
                <div className="hp-phase-desc">Career tracking, alumni network, your journey powers guidance for the next generation.</div>
                <div className="hp-phase-badge">Coming soon</div>
              </div>
            </div>
          </div>
        </ScrollAnim>
      </div>

      {/* Act 5: Social Proof */}
      <div className="hp-act5">
        <ScrollAnim>
          <div className="hp-act5-head">The numbers behind the guidance</div>
        </ScrollAnim>
        <div className="hp-data-cards">
          <ScrollAnim delay={1}>
            <div className="hp-data-card">
              <div className="hp-data-val teal">230,000</div>
              <div className="hp-data-lab">student journeys analysed across 180 countries</div>
            </div>
          </ScrollAnim>
          <ScrollAnim delay={2}>
            <div className="hp-data-card">
              <div className="hp-data-val amber">£12,400</div>
              <div className="hp-data-lab">average hidden costs students discover they didn't know about</div>
            </div>
          </ScrollAnim>
          <ScrollAnim delay={3}>
            <div className="hp-data-card">
              <div className="hp-data-val green">47%</div>
              <div className="hp-data-lab">of students we assessed could get equivalent outcomes for less money</div>
            </div>
          </ScrollAnim>
        </div>
        <div className="hp-quotes">
          <ScrollAnim delay={1}>
            <div className="hp-quote">
              <div className="hp-quote-text">"My family almost committed £140,000 before we saw the real numbers."</div>
              <div className="hp-quote-who">Parent, Lagos</div>
            </div>
          </ScrollAnim>
          <ScrollAnim delay={2}>
            <div className="hp-quote">
              <div className="hp-quote-text">"I was 0.5 below the IELTS requirement. Nobody told me until PathfinderAI."</div>
              <div className="hp-quote-who">Student, Karachi</div>
            </div>
          </ScrollAnim>
          <ScrollAnim delay={3}>
            <div className="hp-quote">
              <div className="hp-quote-text">"The foundation year recommendation saved my application. My agent never mentioned it."</div>
              <div className="hp-quote-who">Student, Shenzhen</div>
            </div>
          </ScrollAnim>
        </div>
        <div className="hp-disc">Sample quotes for demonstration. Platform in prototype.</div>
      </div>

      {/* Act 6: Final CTA */}
      <div className="hp-act6">
        <ScrollAnim>
          <div className="hp-act6-head">See your predicted future</div>
        </ScrollAnim>
        <ScrollAnim>
          <button className="hp-act6-btn" onClick={hasProfile ? () => onNavigate('dashboard') : onStart}>{hasProfile ? 'Go to your dashboard' : 'Start now — it takes 5 minutes'}</button>
        </ScrollAnim>
        <ScrollAnim>
          <div className="hp-act6-muted">Free. No account needed to explore.</div>
        </ScrollAnim>
      </div>

      {/* Footer */}
      <div className="hp-footer">
        <div className="hp-footer-brand">PathfinderAI — a Hyphen Education Group prototype</div>
        <div className="hp-footer-note">Outcome data modelled from HESA Graduate Outcomes</div>
      </div>
    </div>
  );
}

const QUAL_HINTS = {
  "Nigeria":"e.g. WAEC 5 credits including Maths & English",
  "India":"e.g. CBSE 75% in PCM or ISC 70%",
  "China":"e.g. Gaokao 550+ or A-Levels ABB",
  "Pakistan":"e.g. HSC/Intermediate 70%+",
  "Bangladesh":"e.g. HSC GPA 4.5+",
  "Ghana":"e.g. WASSCE 6 credits including Core Maths & English",
  "Saudi Arabia":"e.g. Tawjihi 85%+",
  "Vietnam":"e.g. High School Diploma 7.0+ GPA",
  "Kenya":"e.g. KCSE B+ or above",
  "Turkey":"e.g. Lise Diplomasi 75+"
};

const COUNTRY_EMOJIS = {"Nigeria":"🇳🇬","India":"🇮🇳","China":"🇨🇳","Pakistan":"🇵🇰","Bangladesh":"🇧🇩","Ghana":"🇬🇭","Saudi Arabia":"🇸🇦","Vietnam":"🇻🇳","Kenya":"🇰🇪","Turkey":"🇹🇷"};

// --- Readiness score calculation ---
function calcReadiness(prog, profile) {
  let ieltsScore = 50, qualScore = 60, budgetScore = 50, timeScore = 60;

  // IELTS (35%)
  if (profile.englishType === 'native') { ieltsScore = 100; }
  else if (profile.englishType === 'ielts' || profile.englishType === 'toefl') {
    const s = parseFloat(profile.englishScore) || 0;
    const req = prog.ielts || 6.5;
    if (profile.englishType === 'toefl') {
      // rough TOEFL→IELTS: 79=6.5, 94=7.0
      const equiv = s >= 94 ? 7.0 : s >= 79 ? 6.5 : s >= 60 ? 6.0 : 5.5;
      if (equiv >= req) ieltsScore = 100;
      else if (equiv >= req - 0.5) ieltsScore = 60;
      else ieltsScore = 20;
    } else {
      if (s >= req) ieltsScore = 100;
      else if (s >= req - 0.5) ieltsScore = 60;
      else ieltsScore = 20;
    }
  } else if (profile.englishType === 'planning') { ieltsScore = 50; }

  // Qualifications (30%)
  if (prog.foundation) qualScore = 90;
  else if (profile.qualifications) {
    const q = profile.qualifications.toLowerCase();
    // Simple heuristic: look for strong indicators
    if (q.includes('a-level') || q.includes('a level') || q.includes('cbse') || q.includes('gaokao') || q.includes('waec')) qualScore = 70;
    if (q.includes('aaa') || q.includes('a*') || q.includes('90%') || q.includes('95%')) qualScore = 100;
    else if (q.includes('aab') || q.includes('abb') || q.includes('80%') || q.includes('85%')) qualScore = 80;
    else if (q.includes('bbb') || q.includes('bbc') || q.includes('bcc') || q.includes('70%') || q.includes('75%')) qualScore = 60;
    else if (q.includes('ccc') || q.includes('ccd') || q.includes('ddd') || q.includes('60%')) qualScore = 40;
  }

  // Budget (20%)
  const tc = getTotalCost(prog, profile.country);
  const annualCost = tc.annual;
  const budgetMap = {"Under £15k/year": 15000, "£15-25k": 20000, "£25-35k": 30000, "£35k+": 40000,
    "Under £20k/year": 20000, "£20-30k": 25000, "£30-40k": 35000, "£40k+": 45000};
  const bv = budgetMap[profile.budget] || 25000;
  if (bv >= annualCost) budgetScore = 100;
  else if (bv >= annualCost * 0.8) budgetScore = 70;
  else budgetScore = 30;

  // Timeline (15%)
  const tl = profile.timeline || '';
  if (tl.includes('2027') || tl.includes('exploring')) timeScore = 100;
  else if (tl.includes('September 2026')) timeScore = 80;
  else if (tl.includes('January 2027')) timeScore = 90;
  else timeScore = 60;

  const total = Math.round(ieltsScore * 0.35 + qualScore * 0.30 + budgetScore * 0.20 + timeScore * 0.15);
  return { total, ielts: ieltsScore, quals: qualScore, budget: budgetScore, timeline: timeScore };
}

// --- Match scoring for ranking ---
function matchScore(prog, profile) {
  const readiness = calcReadiness(prog, profile);
  let score = readiness.total;

  // Boost for priorities
  const pri = Array.isArray(profile.priorities) ? profile.priorities : [];
  if (pri.includes('Strong career outcomes') && prog.empRate >= 90) score += 8;
  if (pri.includes('University reputation') && prog.qsRank <= 120) score += 8;
  if (pri.includes('Lower total cost')) {
    const tc = getTotalCost(prog, profile.country);
    if (tc.annual < 25000) score += 8;
  }
  if (pri.includes('Scholarships available') && prog.scholarshipVal > 0) score += 5;

  // Boost for living preference
  const living = profile.living || '';
  const bigCities = ['London','Manchester','Birmingham','Glasgow','Leeds'];
  const smallCities = ['Sheffield','Exeter','Nottingham','Newcastle','Coventry','Leicester','Salford','Brighton'];
  if (living.includes('Big city') && bigCities.includes(prog.city)) score += 5;
  if (living.includes('Smaller city') && smallCities.includes(prog.city)) score += 5;

  // Boost for higher salary
  score += Math.min(10, Math.round(prog.salary / 3000));

  return score;
}

// --- Personal Statement Builder ---
function buildPsSys(profile) {
  return "You are PathfinderAI's application advisor. You are helping a student from " + profile.country + " apply to UK universities for " + profile.subject + ". Their profile: Country: " + profile.country + ", Subject: " + profile.subject + ", Qualifications: " + (profile.qualifications || 'not specified') + ", Career goal: " + (profile.career || 'not specified') + ", Priorities: " + (Array.isArray(profile.priorities) ? profile.priorities.join(', ') : '') + ".\n\nWhen helping with personal statements:\n- Ask specific, probing questions that draw out genuine experiences. Many students undersell themselves.\n- Never write generic statements. Every sentence should be specific to THIS student.\n- Follow UCAS guidelines strictly: max 4,000 characters, 47 lines. One statement for all universities.\n- Avoid: 'From a young age', 'I am passionate about', 'I have always wanted to', 'In today\'s society'. These are clichéd and admissions tutors read thousands of them.\n- Include: Specific examples, reflection on what was learned, connection between experience and course, career awareness, genuine voice.\n- When reviewing, be constructive but honest. If a paragraph is weak, say so and explain why.\n- Be warm and encouraging — many students have never been asked these questions before.";
}

function PSBuilder({ profile, onBack }) {
  const [stage, setStage] = useState(1);
  const [msgs, setMsgs] = useState([]);
  const [input, setInput] = useState('');
  const [loading, setLoading] = useState(false);
  const [draft, setDraft] = useState('');
  const [feedback, setFeedback] = useState('');
  const [refineInput, setRefineInput] = useState('');
  const [generating, setGenerating] = useState(false);
  const [questionIndex, setQuestionIndex] = useState(0);
  const chatEndRef = useRef(null);

  const subject = profile.subject || 'your subject';

  const QUESTIONS = [
    "Why are you interested in " + subject + "? Was there a specific moment or experience that sparked this interest?",
    "Tell me about a time you solved a problem or showed initiative — it doesn't have to be academic. It could be at school, work, or in your community.",
    "What do you want to achieve with this degree? Where do you see yourself in 5 years?",
    "Have you done any work experience, volunteering, or personal projects related to " + subject + "? Tell me about what you did and what you learned.",
    "What's one thing about you that makes you different from other applicants? What would your teachers or friends say is your strength?",
    "Is there anything about your background or life experience that has shaped who you are and your ambitions? It could be cultural, personal, or a challenge you've overcome."
  ];

  useEffect(() => {
    if (chatEndRef.current) chatEndRef.current.scrollIntoView({ behavior: 'smooth' });
  }, [msgs, loading]);

  // Start with first question
  useEffect(() => {
    if (msgs.length === 0) {
      setMsgs([{
        role: 'assistant',
        content: "👋 Let's build your personal statement together! I'll ask you some questions to understand your story, then craft a draft for you.\n\nLet's start — " + QUESTIONS[0]
      }]);
    }
  }, []);

  const callPsAI = async (history, sysPrompt) => {
    const endpoint = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') ? null : '/.netlify/functions/chat';
    const url = endpoint || 'https://api.anthropic.com/v1/messages';
    try {
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          model: "claude-sonnet-4-20250514",
          max_tokens: 2000,
          system: sysPrompt,
          messages: history.map(m => ({ role: m.role, content: m.content }))
        })
      });
      const data = await res.json();
      if (data.error) return { error: data.error.message || "API error" };
      const text = data.content ? data.content.map(c => c.text || '').join('') : "Having trouble connecting.";
      return { text };
    } catch (e) {
      console.error(e);
      return { error: "Connection failed." };
    }
  };

  const sendMessage = async () => {
    if (!input.trim() || loading) return;
    const userMsg = { role: 'user', content: input.trim() };
    const newMsgs = [...msgs, userMsg];
    setMsgs(newMsgs);
    setInput('');
    setLoading(true);

    const nextQ = questionIndex + 1;

    if (nextQ < QUESTIONS.length) {
      // AI acknowledges answer and asks next question
      const ackSys = buildPsSys(profile) + "\n\nYou are in Stage 1 of the personal statement process: gathering material. The student just answered a question. Briefly acknowledge their answer with warmth and encouragement (1-2 sentences), then ask the next question.\n\nNext question to ask: \"" + QUESTIONS[nextQ] + "\"\n\nKeep it conversational and warm. Don't write any personal statement text yet.";
      const result = await callPsAI(newMsgs, ackSys);
      if (result.text) {
        setMsgs(prev => [...prev, { role: 'assistant', content: result.text }]);
      } else {
        setMsgs(prev => [...prev, { role: 'assistant', content: "That's great! " + QUESTIONS[nextQ] }]);
      }
      setQuestionIndex(nextQ);
    } else {
      // All questions answered — final acknowledgment
      const finalSys = buildPsSys(profile) + "\n\nAll 6 questions have been answered. Thank the student warmly for sharing their story. Tell them you now have everything you need to write a strong personal statement. Tell them to click the button below when they're ready. Keep it brief (2-3 sentences).";
      const result = await callPsAI(newMsgs, finalSys);
      if (result.text) {
        setMsgs(prev => [...prev, { role: 'assistant', content: result.text }]);
      } else {
        setMsgs(prev => [...prev, { role: 'assistant', content: "Wonderful — I have everything I need! You've shared some really compelling experiences. Click below when you're ready, and I'll craft your personal statement." }]);
      }
      setQuestionIndex(nextQ);
    }
    setLoading(false);
  };

  const generateDraft = async () => {
    setStage(2);
    setGenerating(true);

    // Collect all user answers from the conversation
    const answers = msgs.filter(m => m.role === 'user').map(m => m.content).join('\n\n');

    const genSys = buildPsSys(profile) + "\n\nYou are in Stage 2: generating the personal statement draft.\n\nUsing the student's answers below, write a complete UCAS personal statement draft.\n\nRULES:\n- Maximum 4,000 characters and 47 lines.\n- Open with a specific hook — NOT 'From a young age' or 'I have always been passionate about'.\n- Reference concrete experiences and examples from their answers.\n- Connect their background to " + subject + " programmes.\n- Show awareness of career pathway.\n- Close with forward-looking ambition.\n- Use their genuine voice — don't make it sound corporate.\n- Every sentence should be specific to THIS student.\n\nOutput ONLY the personal statement text. No explanations, no comments, no headers. Just the statement itself.\n\nStudent's answers:\n" + answers;

    const result = await callPsAI(
      [{ role: 'user', content: "Please write my personal statement based on everything I've shared." }],
      genSys
    );

    if (result.text) {
      setDraft(result.text);
    } else {
      setDraft("There was an error generating your draft. Please try again.");
    }
    setGenerating(false);
    setStage(3);
  };

  const checkMistakes = async () => {
    if (loading) return;
    setLoading(true);
    setFeedback('');
    const checkSys = buildPsSys(profile) + "\n\nReview this UCAS personal statement and check for:\n1. Clichés ('from a young age', 'I am passionate about', 'I have always wanted to', etc.)\n2. Vague language that lacks specific examples\n3. Spelling/grammar issues\n4. Missing elements (no career awareness, no specific examples, no reflection)\n5. Whether it stays within 4,000 characters and 47 lines\n6. Whether the opening is strong enough\n\nGive specific, actionable feedback. Be constructive but honest. If a paragraph is weak, say so and explain why. Format as a bulleted list of issues/suggestions.";
    const result = await callPsAI(
      [{ role: 'user', content: "Review this personal statement:\n\n" + draft }],
      checkSys
    );
    if (result.text) setFeedback(result.text);
    else setFeedback("Couldn't complete the review. Please try again.");
    setLoading(false);
  };

  const reviewForUni = async () => {
    if (loading) return;
    setLoading(true);
    setFeedback('');
    const revSys = buildPsSys(profile) + "\n\nThe student is applying to UK universities for " + subject + ". Review this personal statement specifically for whether it:\n1. Demonstrates genuine interest in the subject\n2. Shows relevant academic preparation\n3. Includes reflection and personal growth\n4. Connects experiences to what universities look for in " + subject + " applicants\n5. Would stand out in a competitive applicant pool\n6. Addresses what Russell Group and top universities value\n\nGive specific, actionable feedback. Be honest and constructive.";
    const result = await callPsAI(
      [{ role: 'user', content: "Review this against university requirements:\n\n" + draft }],
      revSys
    );
    if (result.text) setFeedback(result.text);
    else setFeedback("Couldn't complete the review. Please try again.");
    setLoading(false);
  };

  const refineWithAI = async () => {
    if (!refineInput.trim() || loading) return;
    setLoading(true);
    setFeedback('');
    const refineSys = buildPsSys(profile) + "\n\nThe student has a personal statement draft and wants a specific change. Apply their requested change while keeping the statement within UCAS limits (4,000 chars, 47 lines). Output ONLY the revised personal statement text. No explanations.";
    const result = await callPsAI(
      [{ role: 'user', content: "Here is my current personal statement:\n\n" + draft + "\n\nPlease make this change: " + refineInput.trim() }],
      refineSys
    );
    if (result.text) {
      setDraft(result.text);
      setFeedback("✅ Draft updated based on your request: \"" + refineInput.trim() + "\"");
    }
    setRefineInput('');
    setLoading(false);
  };

  // Character & line counting
  const charCount = draft.length;
  const lineCount = draft.split('\n').length;
  const charColor = charCount > 4000 ? 'over' : charCount > 3900 ? 'red' : charCount > 3500 ? 'amber' : 'green';
  const lineColor = lineCount > 47 ? 'over' : lineCount > 44 ? 'red' : lineCount > 40 ? 'amber' : 'green';
  const charPct = Math.min(100, (charCount / 4000) * 100);
  const fillColor = charCount > 4000 ? '#DC2626' : charCount > 3900 ? '#F87171' : charCount > 3500 ? '#FFB547' : '#34D399';

  const allQuestionsAnswered = questionIndex >= QUESTIONS.length;

  return (
    <div className="ps">
      <div className="ps-hdr">
        <div className="ps-hdr-left">
          <div className="ps-hdr-logo">
            <div className="ps-hdr-logo-sq">P</div>
            <span>Pathfinder<span className="hi">AI</span></span>
          </div>
          <div className="ps-hdr-badge">PERSONAL STATEMENT BUILDER</div>
        </div>
        <button className="ps-hdr-back" onClick={onBack}>← Back to Dashboard</button>
      </div>

      {/* Stage indicators */}
      <div className="ps-stages">
        <div className={"ps-stage" + (stage === 1 ? ' active' : stage > 1 ? ' done' : '')}>
          <div className="ps-stage-dot">{stage > 1 ? '✓' : '1'}</div>
          <div className="ps-stage-label">Gather material</div>
          <div className="ps-stage-line"></div>
        </div>
        <div className={"ps-stage" + (stage === 2 ? ' active' : stage > 2 ? ' done' : '')}>
          <div className="ps-stage-dot">{stage > 2 ? '✓' : '2'}</div>
          <div className="ps-stage-label">Generate draft</div>
          <div className="ps-stage-line"></div>
        </div>
        <div className={"ps-stage" + (stage === 3 ? ' active' : '')}>
          <div className="ps-stage-dot">3</div>
          <div className="ps-stage-label">Review & refine</div>
        </div>
      </div>

      <div className="ps-body">
        {/* Stage 1: Chat questions */}
        {stage === 1 && (
          <div className="ps-chat">
            <div className="ps-chat-msgs">
              {msgs.map((m, i) => (
                <div key={i} className={"ps-chat-msg " + (m.role === 'assistant' ? 'ai' : 'user')}>
                  <div className="ps-chat-who">{m.role === 'assistant' ? 'PathfinderAI' : 'You'}</div>
                  <div className="ps-chat-bubble">
                    {m.content.split('\n').map((line, j) => <span key={j}>{line}<br/></span>)}
                  </div>
                </div>
              ))}
              {loading && (
                <div className="ps-chat-msg ai">
                  <div className="ps-chat-who">PathfinderAI</div>
                  <div className="ps-chat-typing"><span></span><span></span><span></span></div>
                </div>
              )}
              <div ref={chatEndRef}></div>
            </div>

            {!allQuestionsAnswered ? (
              <div className="ps-chat-input">
                <input
                  value={input}
                  onChange={e => setInput(e.target.value)}
                  onKeyDown={e => e.key === 'Enter' && sendMessage()}
                  placeholder="Type your answer..."
                  disabled={loading}
                />
                <button onClick={sendMessage} disabled={loading || !input.trim()}>Send</button>
              </div>
            ) : (
              <div className="ps-generate">
                <button className="ps-generate-btn" onClick={generateDraft} disabled={loading}>
                  ✨ Generate my personal statement
                </button>
                <div className="ps-generate-note">AI will craft a UCAS-compliant draft based on your answers</div>
              </div>
            )}
          </div>
        )}

        {/* Stage 2: Generating */}
        {stage === 2 && generating && (
          <div className="ps-generating">
            <div className="ps-generating-spin"></div>
            <div className="ps-generating-text">Crafting your personal statement...</div>
            <div className="ps-generating-sub">This takes about 15-30 seconds. We're writing something specific to you — not a template.</div>
          </div>
        )}

        {/* Stage 3: Editor & review */}
        {stage === 3 && (
          <div className="ps-editor">
            <div className="ps-editor-head">Your personal statement draft</div>
            <div className="ps-editor-sub">Edit directly below, or ask the AI to refine specific parts. UCAS limit: 4,000 characters / 47 lines.</div>

            {/* Counter */}
            <div className="ps-counter">
              <div className="ps-counter-item">
                <span className="ps-counter-label">Chars</span>
                <span className={"ps-counter-val " + charColor}>{charCount}</span>
                <span className="ps-counter-limit">/ 4,000</span>
              </div>
              <div className="ps-counter-item">
                <span className="ps-counter-label">Lines</span>
                <span className={"ps-counter-val " + lineColor}>{lineCount}</span>
                <span className="ps-counter-limit">/ 47</span>
              </div>
              <div className="ps-counter-bar">
                <div className="ps-counter-fill" style={{ width: charPct + '%', background: fillColor }}></div>
              </div>
            </div>

            {/* Editable textarea */}
            <textarea
              className="ps-textarea"
              value={draft}
              onChange={e => { setDraft(e.target.value); setFeedback(''); }}
              placeholder="Your personal statement will appear here..."
            />

            {/* Review action buttons */}
            <div className="ps-review-bar">
              <button className="ps-review-btn" onClick={checkMistakes} disabled={loading}>
                🔍 Check for common mistakes
              </button>
              <button className="ps-review-btn" onClick={reviewForUni} disabled={loading}>
                🎓 Review against university requirements
              </button>
              <button className="ps-review-btn" onClick={() => { setStage(1); setFeedback(''); }} disabled={loading}>
                ✏️ Re-answer questions
              </button>
              <button className="ps-review-btn" onClick={generateDraft} disabled={loading}>
                🔄 Regenerate from scratch
              </button>
            </div>

            {/* AI refinement input */}
            <div className="ps-refine">
              <input
                value={refineInput}
                onChange={e => setRefineInput(e.target.value)}
                onKeyDown={e => e.key === 'Enter' && refineWithAI()}
                placeholder='Ask AI to change something — e.g. "Make the opening stronger"'
                disabled={loading}
              />
              <button onClick={refineWithAI} disabled={loading || !refineInput.trim()}>Refine</button>
            </div>

            {/* Feedback display */}
            {loading && (
              <div className="ps-feedback">
                <div className="ps-feedback-head">🤖 AI is thinking...</div>
                <div className="ps-feedback-text">Reviewing your statement...</div>
              </div>
            )}
            {feedback && !loading && (
              <div className="ps-feedback">
                <div className="ps-feedback-head">🤖 PathfinderAI feedback</div>
                <div className="ps-feedback-text">
                  {feedback.split('\n').map((line, i) => <span key={i}>{line}<br/></span>)}
                </div>
              </div>
            )}
          </div>
        )}
      </div>
    </div>
  );
}

function Dashboard({ profile, onChat, onBack, onEditProfile, onApply }) {
  const [activeTab, setActiveTab] = useState('matches');
  const [cardTabs, setCardTabs] = useState({});

  const tabs = [
    { id: 'matches', label: 'My Matches' },
    { id: 'valuemap', label: 'Value Map' },
    { id: 'ready', label: 'Am I Ready?' },
    { id: 'aftergrad', label: 'After Graduation' },
    { id: 'dates', label: 'Key Dates' }
  ];

  // Filter and rank programmes
  const subjectMap = {"Business & Management": "Business", "Computer Science & IT": "Computing"};
  const subKey = subjectMap[profile.subject] || '';
  const matched = PROGRAMMES
    .filter(p => !p.foundation && p.subject === subKey)
    .map(p => ({ ...p, score: matchScore(p, profile), readiness: calcReadiness(p, profile) }))
    .sort((a, b) => b.score - a.score)
    .slice(0, 8);

  // Include foundation programmes if IELTS/quals are low
  const needFoundation = profile.englishType === 'ielts' && parseFloat(profile.englishScore) < 6.0;
  const foundationProgs = needFoundation ? PROGRAMMES
    .filter(p => p.foundation && p.subject === subKey)
    .map(p => ({ ...p, score: matchScore(p, profile), readiness: calcReadiness(p, profile) }))
    .sort((a, b) => b.score - a.score)
    .slice(0, 2) : [];

  const allMatches = [...matched, ...foundationProgs];

  const getCardTab = (id) => cardTabs[id] || 'outcomes';
  const setCardTab = (id, tab) => setCardTabs(prev => ({ ...prev, [id]: tab }));

  const getEligBadge = (prog) => {
    if (profile.englishType === 'native') return { cls: 'direct', icon: '✓', label: 'Direct entry — native speaker' };
    if (profile.englishType === 'planning' || !profile.englishScore) return { cls: 'unk', icon: '?', label: 'IELTS score needed to assess' };
    const s = parseFloat(profile.englishScore) || 0;
    const req = prog.ielts || 6.5;
    let equiv = s;
    if (profile.englishType === 'toefl') equiv = s >= 94 ? 7.0 : s >= 79 ? 6.5 : s >= 60 ? 6.0 : 5.5;
    if (equiv >= req) return { cls: 'direct', icon: '✓', label: 'Direct entry' };
    if (equiv >= req - 0.5) return { cls: 'cond', icon: '⚠', label: 'Conditional — may need pre-sessional English' };
    return { cls: 'below', icon: '✗', label: prog.foundation ? 'Foundation year pathway' : 'Below requirement — foundation year recommended' };
  };

  const fmt = n => '£' + n.toLocaleString('en-GB');

  const renderMatches = () => (
    <div>
      <div className="db-content-head">Programmes matched to your profile</div>
      <div className="db-content-sub">Ranked by predicted outcomes for students like you.</div>
      <div className="db-matches">
        {allMatches.map((p, idx) => {
          const tc = getTotalCost(p, profile.country);
          const oc = getOutcome(profile.country, p.qsRank);
          const elig = getEligBadge(p);
          const ct = getCardTab(p.id);
          const r = p.readiness;
          const circ = 2 * Math.PI * 28;
          const offset = circ - (r.total / 100) * circ;
          const rColor = r.total >= 80 ? 'green' : r.total >= 50 ? 'amber' : 'red';

          return (
            <div className="db-match" key={p.id} style={{animationDelay: (idx * 0.08) + 's'}}>
              <div className="db-m-top">
                <div className="db-m-info">
                  <div className="db-m-uni">{p.uni}</div>
                  <div className="db-m-name">{p.name}</div>
                  <div className="db-m-meta">
                    <span>{p.city}</span>
                    <span className="db-m-meta-sep">•</span>
                    <span>{p.duration} years</span>
                    <span className="db-m-meta-sep">•</span>
                    <span>QS #{p.qsRank}</span>
                  </div>
                  <div className="db-m-tags">
                    <span className="db-m-tag fee">{fmt(p.fee)}/yr</span>
                    <span className="db-m-tag city">{p.city}</span>
                    <span className="db-m-tag dur">{p.duration} yrs</span>
                    {p.foundation && <span className="db-m-tag fnd">Foundation year</span>}
                  </div>
                </div>
                <div className="db-m-ready">
                  <div className="db-m-circle">
                    <svg viewBox="0 0 72 72">
                      <circle className="db-m-circle-bg" cx="36" cy="36" r="28" />
                      <circle className={"db-m-circle-fg " + rColor} cx="36" cy="36" r="28"
                        strokeDasharray={circ} strokeDashoffset={offset} />
                    </svg>
                    <div className="db-m-circle-val">{r.total}%</div>
                  </div>
                  <div className="db-m-ready-label">Readiness</div>
                </div>
              </div>

              <div className={"db-m-elig " + elig.cls}>
                <span>{elig.icon}</span>
                <span>{elig.label}</span>
              </div>

              <div className="db-m-tabs">
                <button className={"db-m-tab" + (ct === 'outcomes' ? ' on' : '')} onClick={() => setCardTab(p.id, 'outcomes')}>Outcomes</button>
                <button className={"db-m-tab" + (ct === 'slm' ? ' on' : '')} onClick={() => setCardTab(p.id, 'slm')}>Students Like Me</button>
                <button className={"db-m-tab" + (ct === 'cost' ? ' on' : '')} onClick={() => setCardTab(p.id, 'cost')}>Total Cost</button>
              </div>

              {ct === 'outcomes' && (
                <div className="db-m-panel">
                  <div className="db-m-stats">
                    <div className="db-m-stat"><div className="db-m-stat-val green">{p.empRate}%</div><div className="db-m-stat-label">Employment</div></div>
                    <div className="db-m-stat"><div className="db-m-stat-val teal">{p.highSkill}%</div><div className="db-m-stat-label">Graduate-level</div></div>
                    <div className="db-m-stat"><div className="db-m-stat-val amber">{fmt(p.salary)}</div><div className="db-m-stat-label">Median salary</div></div>
                    <div className="db-m-stat"><div className="db-m-stat-val">{p.satisfaction}%</div><div className="db-m-stat-label">Satisfaction</div></div>
                  </div>
                </div>
              )}

              {ct === 'slm' && (
                <div className="db-m-panel">
                  <div className="db-m-slm">
                    <div className="db-m-slm-head">🌍 Students from {profile.country}</div>
                    <div className="db-m-slm-stats">
                      <div className="db-m-slm-stat"><div className="db-m-slm-val">{oc.empRate}%</div><div className="db-m-slm-lab">Employed</div></div>
                      <div className="db-m-slm-stat"><div className="db-m-slm-val">{fmt(oc.salary)}</div><div className="db-m-slm-lab">Salary</div></div>
                      <div className="db-m-slm-stat"><div className="db-m-slm-val">{oc.highSkill}%</div><div className="db-m-slm-lab">Graduate jobs</div></div>
                    </div>
                    <div className="db-m-slm-note">{oc.note}</div>
                  </div>
                </div>
              )}

              {ct === 'cost' && (
                <div className="db-m-panel">
                  <div className="db-m-cost">
                    <div className="db-m-cost-head">💰 Full cost breakdown ({p.duration} years)</div>
                    <div className="db-m-cost-rows">
                      <div className="db-m-cost-row"><span>Tuition fees ({p.duration} yrs)</span><span>{fmt(p.fee * p.duration)}</span></div>
                      <div className="db-m-cost-row"><span>Living costs ({p.duration} yrs)</span><span>{fmt(p.livingCost * p.duration)}</span></div>
                      <div className="db-m-cost-row sub"><span>IHS ({p.duration} yrs)</span><span>{fmt(tc.ihs * p.duration)}</span></div>
                      <div className="db-m-cost-row sub"><span>Student visa</span><span>{fmt(tc.visa)}</span></div>
                      <div className="db-m-cost-row sub"><span>Flights (return)</span><span>{fmt(tc.flight)}</span></div>
                      <div className="db-m-cost-div"></div>
                      <div className="db-m-cost-row db-m-cost-total"><span>Total estimated cost</span><span>{fmt(tc.total)}</span></div>
                      {p.scholarshipVal > 0 && <>
                        <div className="db-m-cost-row" style={{color:'#34D399'}}><span>Potential scholarship ({p.duration} yrs)</span><span>-{fmt(tc.scholTotal)}</span></div>
                        <div className="db-m-cost-div"></div>
                        <div className="db-m-cost-row db-m-cost-total"><span>Total if scholarship awarded</span><span>{fmt(tc.totalAfterSchol)}</span></div>
                      </>}
                    </div>
                    {p.scholarshipVal > 0 && (
                      <div className="db-m-cost-schol">💎 {p.scholarship}</div>
                    )}
                  </div>
                </div>
              )}

              <div className="db-m-actions">
                <button className="db-m-action" onClick={() => onChat && onChat('Tell me more about ' + p.name + ' at ' + p.uni)}>Ask PathfinderAI about this →</button>
                <button className="db-m-action">Experience this university →</button>
                <button className="db-m-action" onClick={() => onApply && onApply()}>Start my application →</button>
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );

  const renderPlaceholder = (icon, title, sub) => (
    <div className="db-placeholder-tab">
      <div className="db-placeholder-tab-icon">{icon}</div>
      <div className="db-placeholder-tab-title">{title}</div>
      <div className="db-placeholder-tab-sub">{sub}</div>
    </div>
  );

  const renderTabContent = () => {
    switch (activeTab) {
      case 'matches': return renderMatches();
      case 'valuemap': return renderPlaceholder('📊', 'Value Map', 'Every programme mapped by what it costs versus what it delivers. Coming soon.');
      case 'ready': return renderPlaceholder('✅', 'Am I Ready?', 'Your readiness for each programme — what you need to do, and what\'s already sorted. Coming soon.');
      case 'aftergrad': return renderPlaceholder('🚀', 'After Graduation', 'What happens after you graduate — Graduate Route visa, first roles, salary progression. Coming soon.');
      case 'dates': return renderPlaceholder('📅', 'Key Dates', 'Every deadline that matters — UCAS, scholarships, visa, accommodation. Coming soon.');
      default: return null;
    }
  };

  return (
    <div className="db">
      <div className="db-hdr">
        <div className="db-hdr-inner">
          <div className="db-hdr-left">
            <div className="db-hdr-logo">
              <div className="db-hdr-logo-sq">P</div>
              <div className="db-hdr-logo-t">Pathfinder<span className="hi">AI</span></div>
            </div>
            <div className="db-hdr-stu">
              <span className="db-hdr-flag">{COUNTRY_EMOJIS[profile.country] || '🌍'}</span>
              <span>{profile.country} · {profile.subject}</span>
            </div>
          </div>
          <div className="db-hdr-right">
            <button className="db-hdr-btn" onClick={onBack}>← Home</button>
            <button className="db-hdr-btn" onClick={onEditProfile}>✎ Edit profile</button>
          </div>
        </div>
      </div>

      <div className="db-tabs-wrap">
        <div className="db-tabs">
          {tabs.map(t => (
            <button key={t.id} className={"db-tab" + (activeTab === t.id ? ' on' : '')} onClick={() => setActiveTab(t.id)}>{t.label}</button>
          ))}
        </div>
      </div>

      <div className="db-feats">
        <button className="db-feat" onClick={() => onApply && onApply()}><span className="db-feat-icon">📝</span> Apply with AI</button>
        <button className="db-feat"><span className="db-feat-icon">💷</span> Financial Plan</button>
        <button className="db-feat"><span className="db-feat-icon">🏛️</span> Experience a University</button>
      </div>

      <div className="db-content">
        {renderTabContent()}
      </div>

      <button className="db-chat-fab" onClick={() => onChat && onChat()}>
        💬 Chat with PathfinderAI
      </button>
    </div>
  );
}

function ProfileBuilder({ onComplete, onBack, initialData, onReset }) {
  const hasInit = !!(initialData && initialData.country);
  const [step, setStep] = useState(hasInit ? 10 : 1);
  const [slideKey, setSlideKey] = useState(0);
  const [pb, setPb] = useState(hasInit ? {
    country: initialData.country || '', subject: initialData.subject || '',
    qualifications: initialData.qualifications || '', englishType: initialData.englishType || '',
    englishScore: initialData.englishScore || '', budget: initialData.budget || '',
    funding: initialData.funding || [], priorities: initialData.priorities || [],
    career: initialData.career || '', living: initialData.living || '',
    hasFriends: initialData.hasFriends != null ? initialData.hasFriends : null,
    friendsWhere: initialData.friendsWhere || '', timeline: initialData.timeline || ''
  } : {
    country: '', subject: '', qualifications: '', englishType: '', englishScore: '',
    budget: '', funding: [], priorities: [], career: '', living: '', hasFriends: null,
    friendsWhere: '', timeline: ''
  });

  const upd = (k, v) => setPb(p => ({...p, [k]: v}));
  const toggleArr = (k, v, max) => setPb(p => {
    const arr = p[k]; if (arr.includes(v)) return {...p, [k]: arr.filter(x=>x!==v)};
    if (max && arr.length >= max) return p; return {...p, [k]: [...arr, v]};
  });

  const go = (s) => { setSlideKey(k => k+1); setStep(s); window.scrollTo(0,0); };
  const next = () => go(step + 1);
  const back = () => step > 1 ? go(step - 1) : onBack();

  const pct = ((step - 1) / 9) * 100;

  // Step validity
  const valid = {
    1: !!pb.country, 2: !!pb.subject, 3: pb.qualifications.length > 2,
    4: !!pb.englishType, 5: !!pb.budget, 6: pb.priorities.length > 0,
    7: !!pb.career, 8: !!pb.living, 9: !!pb.timeline, 10: true
  };

  const renderStep = () => {
    switch(step) {
      case 1: return (<div className="pb-slide" key={slideKey}>
        <div className="pb-q">Where's home?</div>
        <div className="pb-helper">This shapes everything — from visa costs to which student communities you'll find.</div>
        <div className="pb-grid">
          {HP_COUNTRIES.map(c => (
            <div key={c} className={"pb-card" + (pb.country===c?" on":"")} onClick={() => { upd('country',c); setTimeout(next, 200); }}>
              <div className="pb-card-emoji">{COUNTRY_EMOJIS[c]||'🌍'}</div>
              <div className="pb-card-label">{c}</div>
            </div>
          ))}
          <div className={"pb-card" + (pb.country && !HP_COUNTRIES.includes(pb.country)?" on":"")} onClick={() => upd('country','Other')}>
            <div className="pb-card-emoji">🌍</div>
            <div className="pb-card-label">Other</div>
          </div>
        </div>
        {pb.country === 'Other' && <div style={{marginTop:16}}><select className="pb-input" value="" onChange={e => { upd('country',e.target.value); setTimeout(next, 200); }} style={{cursor:'pointer'}}>
          <option value="" disabled>Search your country...</option>
          {COUNTRY_LIST.filter(c => !HP_COUNTRIES.includes(c) && c !== 'Other').map(c => <option key={c} value={c}>{c}</option>)}
        </select></div>}
      </div>);

      case 2: return (<div className="pb-slide" key={slideKey}>
        <div className="pb-q">What do you want to study?</div>
        <div className="pb-helper">We'll match you with programmes and show career outcomes in this field.</div>
        <div className="pb-grid pb-grid-3">
          {[{l:'Business & Management',e:'📊'},{l:'Computer Science & IT',e:'💻'},{l:'Not sure yet',e:'🤔',s:'Help me explore'}].map(o => (
            <div key={o.l} className={"pb-card" + (pb.subject===o.l?" on":"")} onClick={() => { upd('subject',o.l); setTimeout(next, 200); }}>
              <div className="pb-card-emoji">{o.e}</div>
              <div className="pb-card-label">{o.l}</div>
              {o.s && <div className="pb-card-sub">{o.s}</div>}
            </div>
          ))}
        </div>
      </div>);

      case 3: return (<div className="pb-slide" key={slideKey}>
        <div className="pb-q">What qualifications have you got?</div>
        <div className="pb-helper">We'll check which universities you can enter directly — and flag if a foundation year would open better options.</div>
        <input className="pb-input" placeholder={QUAL_HINTS[pb.country] || "e.g. A-Levels BBB, IB 32 points"} value={pb.qualifications} onChange={e => upd('qualifications',e.target.value)} autoFocus />
        <button className={"pb-next" + (valid[3]?" ready":"")} onClick={next}>Continue</button>
      </div>);

      case 4: return (<div className="pb-slide" key={slideKey}>
        <div className="pb-q">How's your English?</div>
        <div className="pb-helper">Most UK universities need IELTS 6.0–6.5. We'll tell you exactly where you stand for each programme.</div>
        <div className="pb-grid pb-grid-2">
          {[{l:'I have IELTS',v:'ielts',e:'📝'},{l:'I have TOEFL',v:'toefl',e:'📝'},{l:'Planning to take a test',v:'planning',e:'📅'},{l:'English is my first language',v:'native',e:'🗣️'}].map(o => (
            <div key={o.v} className={"pb-card" + (pb.englishType===o.v?" on":"")} onClick={() => { upd('englishType',o.v); if (o.v==='planning'||o.v==='native') setTimeout(next, 200); }}>
              <div className="pb-card-emoji">{o.e}</div>
              <div className="pb-card-label">{o.l}</div>
            </div>
          ))}
        </div>
        {(pb.englishType==='ielts'||pb.englishType==='toefl') && (
          <div className="pb-score-row">
            <input className="pb-score-input" placeholder={pb.englishType==='ielts'?'6.5':'90'} value={pb.englishScore} onChange={e => upd('englishScore',e.target.value)} autoFocus />
            <span className="pb-score-label">{pb.englishType==='ielts'?'Overall band score':'Total score'}</span>
          </div>
        )}
        <button className={"pb-next" + (valid[4]?" ready":"")} onClick={next}>Continue</button>
      </div>);

      case 5: return (<div className="pb-slide" key={slideKey}>
        <div className="pb-q">What can your family invest per year?</div>
        <div className="pb-helper">Tuition is only about 60% of the real cost. We'll calculate the full picture.</div>
        <div className="pb-grid pb-grid-2">
          {[{l:'Under £20k/yr',v:'Under £20,000/yr'},{l:'£20–30k/yr',v:'£20,000-£30,000/yr'},{l:'£30–40k/yr',v:'£30,000-£40,000/yr'},{l:'£40k+/yr',v:'Over £40,000/yr'}].map(o => (
            <div key={o.v} className={"pb-card" + (pb.budget===o.v?" on":"")} onClick={() => upd('budget',o.v)}>
              <div className="pb-card-label">{o.l}</div>
            </div>
          ))}
        </div>
        <div className="pb-sub-q">Who's funding this?</div>
        <div className="pb-pills">
          {['Family savings','Need scholarship','Government sponsor','Self-funded','Mix of sources'].map(f => (
            <button key={f} className={"pb-pill" + (pb.funding.includes(f)?" on":"")} onClick={() => toggleArr('funding',f)}>{f}</button>
          ))}
        </div>
        <button className={"pb-next" + (valid[5]?" ready":"")} onClick={next}>Continue</button>
      </div>);

      case 6: return (<div className="pb-slide" key={slideKey}>
        <div className="pb-q">What matters most to you?</div>
        <div className="pb-helper">Everyone weighs things differently. Pick up to 3.</div>
        <div className="pb-chips">
          {['Strong career outcomes','University reputation','Lower total cost','City with strong community from my country','Scholarships available','Safety and support','Part-time work opportunities','Campus and social life'].map(p => (
            <button key={p} className={"pb-chip" + (pb.priorities.includes(p)?" on":"")} onClick={() => toggleArr('priorities',p,3)}>{p}</button>
          ))}
        </div>
        <button className={"pb-next" + (valid[6]?" ready":"")} onClick={next}>Continue</button>
      </div>);

      case 7: return (<div className="pb-slide" key={slideKey}>
        <div className="pb-q">What do you want your life to look like in 5 years?</div>
        <div className="pb-helper">This changes which universities and programmes make sense. The 2-year Graduate Route visa makes UK careers possible.</div>
        <div className="pb-grid pb-grid-3">
          {[{l:'Working in the UK',e:'🇬🇧'},{l:'Return home with a UK edge',e:'🏠'},{l:'Start my own business',e:'🚀'},{l:'Further study',e:'🎓',s:'Masters or PhD'},{l:'Keep options open',e:'🌐'}].map(o => (
            <div key={o.l} className={"pb-card" + (pb.career===o.l?" on":"")} onClick={() => { upd('career',o.l); setTimeout(next, 200); }}>
              <div className="pb-card-emoji">{o.e}</div>
              <div className="pb-card-label">{o.l}</div>
              {o.s && <div className="pb-card-sub">{o.s}</div>}
            </div>
          ))}
        </div>
      </div>);

      case 8: return (<div className="pb-slide" key={slideKey}>
        <div className="pb-q">What kind of place do you want to live?</div>
        <div className="pb-helper">City choice affects your cost of living by up to £3,000/year — and your social experience.</div>
        <div className="pb-grid pb-grid-3">
          {[{l:'Big city energy',e:'🏙️'},{l:'Smaller city, bigger value',e:'🌳'},{l:'Best programme wins',e:'🎯',s:"Location doesn't matter"}].map(o => (
            <div key={o.l} className={"pb-card" + (pb.living===o.l?" on":"")} onClick={() => upd('living',o.l)}>
              <div className="pb-card-emoji">{o.e}</div>
              <div className="pb-card-label">{o.l}</div>
              {o.s && <div className="pb-card-sub">{o.s}</div>}
            </div>
          ))}
        </div>
        <div className="pb-bonus">
          <div className="pb-bonus-q">Do you have family or friends already in the UK?</div>
          <div className="pb-bonus-row">
            <button className={"pb-bonus-btn" + (pb.hasFriends===true?" on":"")} onClick={() => upd('hasFriends',true)}>Yes</button>
            <button className={"pb-bonus-btn" + (pb.hasFriends===false?" on":"")} onClick={() => upd('hasFriends',false)}>No</button>
            {pb.hasFriends===true && <input className="pb-bonus-input" placeholder="Where in the UK?" value={pb.friendsWhere} onChange={e => upd('friendsWhere',e.target.value)} />}
          </div>
        </div>
        <button className={"pb-next" + (valid[8]?" ready":"")} onClick={next}>Continue</button>
      </div>);

      case 9: return (<div className="pb-slide" key={slideKey}>
        <div className="pb-q">When do you want to start?</div>
        <div className="pb-helper">This tells us which deadlines matter and how much preparation time you have.</div>
        <div className="pb-grid pb-grid-2">
          {[{l:'September 2026',e:'🍂'},{l:'January 2027',e:'❄️'},{l:'September 2027',e:'📆'},{l:'Just exploring',e:'🔍'}].map(o => (
            <div key={o.l} className={"pb-card" + (pb.timeline===o.l?" on":"")} onClick={() => { upd('timeline',o.l); setTimeout(() => go(10), 200); }}>
              <div className="pb-card-emoji">{o.e}</div>
              <div className="pb-card-label">{o.l}</div>
            </div>
          ))}
        </div>
      </div>);

      case 10: return (<div className="pb-slide" key={slideKey}>
        <div className="pb-q" style={{textAlign:'center'}}>Here's what we know.<br/>Ready to see your future?</div>
        <div className="pb-summary">
          <div className="pb-summary-row"><span className="pb-summary-label">Home</span><span className="pb-summary-val">{pb.country}</span></div>
          <div className="pb-summary-row"><span className="pb-summary-label">Subject</span><span className="pb-summary-val">{pb.subject}</span></div>
          <div className="pb-summary-row"><span className="pb-summary-label">Qualifications</span><span className="pb-summary-val">{pb.qualifications}</span></div>
          <div className="pb-summary-row"><span className="pb-summary-label">English</span><span className="pb-summary-val">{pb.englishType==='ielts'?'IELTS '+pb.englishScore:pb.englishType==='toefl'?'TOEFL '+pb.englishScore:pb.englishType==='native'?'Native speaker':'Planning to test'}</span></div>
          <div className="pb-summary-row"><span className="pb-summary-label">Budget</span><span className="pb-summary-val">{pb.budget}</span></div>
          {pb.funding.length > 0 && <div className="pb-summary-row"><span className="pb-summary-label">Funding</span><span className="pb-summary-val">{pb.funding.join(', ')}</span></div>}
          <div className="pb-summary-row"><span className="pb-summary-label">Priorities</span><span className="pb-summary-val">{pb.priorities.join(', ')}</span></div>
          <div className="pb-summary-row"><span className="pb-summary-label">Career goal</span><span className="pb-summary-val">{pb.career}</span></div>
          <div className="pb-summary-row"><span className="pb-summary-label">Living</span><span className="pb-summary-val">{pb.living}</span></div>
          {pb.hasFriends && <div className="pb-summary-row"><span className="pb-summary-label">UK contacts</span><span className="pb-summary-val">{pb.friendsWhere || 'Yes'}</span></div>}
          <div className="pb-summary-row"><span className="pb-summary-label">Start date</span><span className="pb-summary-val">{pb.timeline}</span></div>
          <button className="pb-launch" onClick={() => onComplete(pb)}>See my predicted outcomes →</button>
          <button className="pb-edit" onClick={() => go(1)}>Edit my profile</button>
          {onReset && <button className="pb-edit" style={{marginTop:8,color:'#F87171',borderColor:'rgba(248,113,113,0.2)'}} onClick={onReset}>🔄 Start over — clear all data</button>}
        </div>
      </div>);

      default: return null;
    }
  };

  return (
    <div className="pb">
      <div className="pb-bar"><div className="pb-fill" style={{width: pct + '%'}}></div></div>
      <div className="pb-top">
        <button className="pb-back" onClick={back}>← {step > 1 ? 'Back' : (hasInit ? 'Dashboard' : 'Home')}</button>
        <div className="pb-logo"><div className="pb-logo-sq">P</div><span>Pathfinder<span className="hi">AI</span></span></div>
        <div className="pb-step-count">{step} of 10</div>
      </div>
      <div className="pb-body">
        {renderStep()}
      </div>
    </div>
  );
}

function App() {
  // Load saved profile from localStorage
  const savedProfile = (() => {
    try { const s = localStorage.getItem('pf_profile'); return s ? JSON.parse(s) : {}; } catch(e) { return {}; }
  })();
  const hasProfile = !!(savedProfile && savedProfile.country && savedProfile.subject);

  const [currentView, setCurrentView] = useState(hasProfile ? 'dashboard' : 'home');
  const [profile, setProfileRaw] = useState(hasProfile ? savedProfile : {});
  const [msgs, setMsgs] = useState([]);
  const [input, setInput] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [selPri, setSelPri] = useState([]);
  const endRef = useRef(null);
  useEffect(() => { if (endRef.current) endRef.current.scrollIntoView({behavior:'smooth'}); }, [msgs, loading]);

  // Wrapper: save to localStorage whenever profile changes
  const setProfile = (p) => {
    setProfileRaw(p);
    if (p && p.country) {
      try { localStorage.setItem('pf_profile', JSON.stringify(p)); } catch(e) {}
    }
  };

  // Full reset — clears localStorage and returns to homepage
  const fullReset = () => {
    try { localStorage.removeItem('pf_profile'); } catch(e) {}
    setProfileRaw({});
    setMsgs([]);
    setSelPri([]);
    setError(null);
    setCurrentView('home');
  };

  const callAI = async (history, prof) => {
    setLoading(true); setError(null);
    try {
      const endpoint = API_ENDPOINT || 'https://api.anthropic.com/v1/messages';
      const res = await fetch(endpoint, { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:1000,system:buildSys(prof||profile),messages:history.map(m=>({role:m.role,content:m.content}))}) });
      const data = await res.json();
      if (data.error) { setError(data.error.message || "API error"); setLoading(false); return; }
      const text = data.content ? data.content.map(c => c.text || '').join('') : "Having trouble connecting. Please try again.";
      setMsgs(prev => [...prev, {role:'assistant', content:text, parsed:parseMsg(text)}]);
    } catch(e) { console.error(e); setError("Connection failed — check the Netlify function and API key."); }
    setLoading(false);
  };

  const launch = async (fp) => {
    const p = fp || profile;
    setProfile(p);
    const engStr = p.englishType === 'ielts' ? 'IELTS ' + p.englishScore : p.englishType === 'toefl' ? 'TOEFL ' + p.englishScore : p.englishType === 'native' ? 'Native English speaker' : "Haven't taken English test yet";
    const intro = "Hi! I'm from " + p.country + ". I want to study " + p.subject + " in the UK. My qualifications: " + p.qualifications + ". English: " + engStr + ". Budget: " + p.budget + ". Most important: " + (p.priorities || []).join(', ') + ". Career goal: " + (p.career || 'not specified') + ".";
    setMsgs([{role:'user',content:intro,parsed:{text:intro,programmes:[]}}]);
    setCurrentView('chat');
    await callAI([{role:'user',content:intro}], p);
  };

  const send = async () => {
    if (!input.trim() || loading) return;
    const nm = [...msgs, {role:'user',content:input.trim(),parsed:{text:input.trim(),programmes:[]}}];
    setMsgs(nm); setInput('');
    await callAI(nm.map(m=>({role:m.role,content:m.content})), profile);
  };

  const quick = async (t) => {
    const nm = [...msgs, {role:'user',content:t,parsed:{text:t,programmes:[]}}];
    setMsgs(nm);
    await callAI(nm.map(m=>({role:m.role,content:m.content})), profile);
  };

  const restart = () => { setCurrentView('home'); setMsgs([]); setSelPri([]); setError(null); };

  // Homepage (default landing)
  if (currentView === 'home') return (
    <Homepage
      onStart={() => setCurrentView('profile')}
      profile={profile}
      onNavigate={(view) => {
        if (view === 'chat') { launch(profile); }
        else { setCurrentView(view); }
      }}
    />
  );

  // Profile Builder (10-step wizard)
  if (currentView === 'profile') return (
    <ProfileBuilder
      onComplete={(pb) => {
        setProfile(pb);
        setCurrentView('dashboard');
      }}
      onBack={() => profile.country ? setCurrentView('dashboard') : setCurrentView('home')}
      initialData={profile.country ? profile : null}
      onReset={fullReset}
    />
  );

  // Dashboard
  if (currentView === 'dashboard') return (
    <Dashboard
      profile={profile}
      onChat={(msg) => {
        if (msg) {
          // Launch chat with a specific question
          const history = [{role:'user', content: msg, parsed:{text: msg, programmes:[]}}];
          setMsgs(history);
          setCurrentView('chat');
          callAI([{role:'user', content: msg}], profile);
        } else {
          // General chat — auto-introduce
          launch(profile);
        }
      }}
      onBack={() => setCurrentView('home')}
      onEditProfile={() => setCurrentView('profile')}
      onApply={() => setCurrentView('apply')}
    />
  );

  // Apply — Personal Statement Builder
  if (currentView === 'apply') return (
    <PSBuilder
      profile={profile}
      onBack={() => setCurrentView('dashboard')}
    />
  );

  // Chat view
  return (
    <div className="app"><div className="chat">
      <div className="ch-head">
        <div className="ch-left">
          <button className="ch-back" onClick={() => profile.country ? setCurrentView('dashboard') : restart()}>← {profile.country ? 'Dashboard' : 'Home'}</button>
          <div className="ch-logo">P</div>
          <div className="ch-title">Pathfinder<span className="logo-hi">AI</span></div>
        </div>
        <div className="ch-tags"><span className="ch-trust">WORKS FOR YOU</span>{profile.country && <span className="ch-tag">{profile.country}</span>}{profile.subject && <span className="ch-tag">{profile.subject}</span>}</div>
      </div>
      <div className="ch-msgs">
        {msgs.map((m, i) => (
          <div key={i} className={"msg " + (m.role==='assistant'?'a':'u')}>
            <div className="msg-who">{m.role==='assistant'?'PathfinderAI':'You'}</div>
            <div className="bubble">
              {m.parsed && m.parsed.text && m.parsed.text.split('\n').map((line, j) => <span key={j}>{line}<br/></span>)}
              {m.parsed && m.parsed.programmes && m.parsed.programmes.length > 0 && (
                <div className="pcards">{m.parsed.programmes.map(pid => <ProgrammeCard key={pid} progId={pid} country={profile.country} ielts={profile.englishScore || profile.ielts} />)}</div>
              )}
            </div>
          </div>
        ))}
        {loading && <div className="msg a"><div className="msg-who">PathfinderAI</div><div className="typing"><div className="td"></div><div className="td"></div><div className="td"></div></div></div>}
        {error && <div className="err-box">{error}</div>}
        <div ref={endRef}></div>
      </div>
      <div className="ch-input">
        <div className="in-row">
          <input className="in-box" placeholder="Ask me anything about studying in the UK..." value={input} onChange={e=>setInput(e.target.value)} onKeyDown={e=>e.key==='Enter'&&send()} disabled={loading} />
          <button className="in-btn" onClick={send} disabled={loading||!input.trim()}>Send</button>
        </div>
        {msgs.length <= 2 && <div className="quicks">
          <button className="qb" onClick={()=>quick('What are the most affordable options with good outcomes?')}>Best value</button>
          <button className="qb" onClick={()=>quick('Show me the real total cost of each option')}>True total costs</button>
          <button className="qb" onClick={()=>quick('Do I need a foundation year?')}>Foundation year?</button>
          <button className="qb" onClick={()=>quick('What happened to students from my country at these universities?')}>Students like me</button>
          <button className="qb" onClick={()=>quick("Is a more expensive university worth it?")}>Worth the cost?</button>
        </div>}
      </div>
      <div className="footer">PathfinderAI prototype — Outcome data modelled from <a href="https://www.hesa.ac.uk" target="_blank">HESA</a> Graduate Outcomes. Not for production use.</div>
    </div></div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
